{
    "language": "python",
    "commit_url": "https://github.com/zulip/zulip/commit/0f46fd86dd84c9ce1e61a052ae6cc214e90ea5e4",
    "commit_message": "urls: Rename arguments to accounts/unsubscribe.\n\ntype -> email_type to match future work on ScheduledJob.\n\ntoken -> confirmation_key to match what the other confirmation views urls\ncall this argument.",
    "commit_snapshots": {
        "zerver/lib/notifications.py": [
            [
                "from __future__ import print_function\n",
                "\n",
                "from typing import cast, Any, Dict, Iterable, List, Mapping, Optional, Sequence, Tuple, Text\n",
                "\n",
                "from confirmation.models import Confirmation\n",
                "from django.conf import settings\n",
                "from django.template import loader\n",
                "from django.utils.timezone import now as timezone_now\n",
                "from zerver.decorator import statsd_increment\n",
                "from zerver.lib.send_email import send_future_email, display_email, \\\n",
                "    send_email_from_dict, FromAddress\n",
                "from zerver.lib.queue import queue_json_publish\n",
                "from zerver.models import (\n",
                "    Recipient,\n",
                "    ScheduledJob,\n",
                "    UserMessage,\n",
                "    Stream,\n",
                "    get_display_recipient,\n",
                "    UserProfile,\n",
                "    get_user_profile_by_email,\n",
                "    get_user_profile_by_id,\n",
                "    receives_offline_notifications,\n",
                "    get_context_for_message,\n",
                "    Message,\n",
                "    Realm,\n",
                ")\n",
                "\n",
                "import datetime\n",
                "from email.utils import formataddr\n",
                "import re\n",
                "import subprocess\n",
                "import ujson\n",
                "from six.moves import urllib\n",
                "from collections import defaultdict\n",
                "\n",
                "def unsubscribe_token(user_profile):\n",
                "    # type: (UserProfile) -> Text\n",
                "    # Leverage the Django confirmations framework to generate and track unique\n",
                "    # unsubscription tokens.\n",
                "    return Confirmation.objects.get_link_for_object(user_profile, 'unused').split(\"/\")[-1]\n",
                "\n"
            ],
            {
                "type": "replace",
                "before": [
                    "def one_click_unsubscribe_link(user_profile, endpoint):\n"
                ],
                "after": [
                    "def one_click_unsubscribe_link(user_profile, email_type):\n"
                ],
                "parent_version_range": {
                    "start": 41,
                    "end": 42
                },
                "child_version_range": {
                    "start": 41,
                    "end": 42
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "one_click_unsubscribe_link",
                        "signature": "def one_click_unsubscribe_link(user_profile, endpoint):",
                        "at_line": 41
                    }
                ],
                "idx": 0,
                "hunk_diff": "File: zerver/lib/notifications.py\nCode:\n38 38        # unsubscription tokens.\n39 39        return Confirmation.objects.get_link_for_object(user_profile, 'unused').split(\"/\")[-1]\n40 40    \n41     - def one_click_unsubscribe_link(user_profile, endpoint):\n   41  + def one_click_unsubscribe_link(user_profile, email_type):\n42 42        # type: (UserProfile, Text) -> Text\n43 43        \"\"\"\n44 44        Generate a unique link that a logged-out user can visit to unsubscribe from\n       ...\n",
                "file_path": "zerver/lib/notifications.py",
                "identifiers_before": [
                    "endpoint",
                    "one_click_unsubscribe_link",
                    "user_profile"
                ],
                "identifiers_after": [
                    "email_type",
                    "one_click_unsubscribe_link",
                    "user_profile"
                ],
                "prefix": [
                    "    # unsubscription tokens.\n",
                    "    return Confirmation.objects.get_link_for_object(user_profile, 'unused').split(\"/\")[-1]\n",
                    "\n"
                ],
                "suffix": [
                    "    # type: (UserProfile, Text) -> Text\n",
                    "    \"\"\"\n",
                    "    Generate a unique link that a logged-out user can visit to unsubscribe from\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [
                    {
                        "to_hunk_idx": 1,
                        "detail": {
                            "identifier": "endpoint",
                            "position": {
                                "start": {
                                    "line": 41,
                                    "column": 45
                                },
                                "end": {
                                    "line": 41,
                                    "column": 53
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/lib/notifications.py",
                            "hunk_idx": 0,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 1,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 41,
                                    "column": 45
                                },
                                "end": {
                                    "line": 41,
                                    "column": 55
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/lib/notifications.py",
                            "hunk_idx": 0,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": [
                    1
                ]
            },
            [
                "    # type: (UserProfile, Text) -> Text\n",
                "    \"\"\"\n",
                "    Generate a unique link that a logged-out user can visit to unsubscribe from\n",
                "    Zulip e-mails without having to first log in.\n",
                "    \"\"\"\n",
                "    token = unsubscribe_token(user_profile)\n"
            ],
            {
                "type": "replace",
                "before": [
                    "    resource_path = \"accounts/unsubscribe/%s/%s\" % (endpoint, token)\n"
                ],
                "after": [
                    "    resource_path = \"accounts/unsubscribe/%s/%s\" % (email_type, token)\n"
                ],
                "parent_version_range": {
                    "start": 48,
                    "end": 49
                },
                "child_version_range": {
                    "start": 48,
                    "end": 49
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "one_click_unsubscribe_link",
                        "signature": "def one_click_unsubscribe_link(user_profile, endpoint):",
                        "at_line": 41
                    }
                ],
                "idx": 1,
                "hunk_diff": "File: zerver/lib/notifications.py\nCode:\n         def one_click_unsubscribe_link(user_profile, endpoint):\n             ...\n45 45        Zulip e-mails without having to first log in.\n46 46        \"\"\"\n47 47        token = unsubscribe_token(user_profile)\n48     -     resource_path = \"accounts/unsubscribe/%s/%s\" % (endpoint, token)\n   48  +     resource_path = \"accounts/unsubscribe/%s/%s\" % (email_type, token)\n49 49        return \"%s/%s\" % (user_profile.realm.uri.rstrip(\"/\"), resource_path)\n50 50    \n51 51    def hash_util_encode(string):\n       ...\n",
                "file_path": "zerver/lib/notifications.py",
                "identifiers_before": [
                    "endpoint",
                    "resource_path",
                    "token"
                ],
                "identifiers_after": [
                    "email_type",
                    "resource_path",
                    "token"
                ],
                "prefix": [
                    "    Zulip e-mails without having to first log in.\n",
                    "    \"\"\"\n",
                    "    token = unsubscribe_token(user_profile)\n"
                ],
                "suffix": [
                    "    return \"%s/%s\" % (user_profile.realm.uri.rstrip(\"/\"), resource_path)\n",
                    "\n",
                    "def hash_util_encode(string):\n"
                ],
                "base_dependency_callee": [
                    {
                        "to_hunk_idx": 0,
                        "detail": {
                            "identifier": "endpoint",
                            "position": {
                                "start": {
                                    "line": 48,
                                    "column": 52
                                },
                                "end": {
                                    "line": 48,
                                    "column": 60
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/lib/notifications.py",
                            "hunk_idx": 1,
                            "dependency_checked": true
                        }
                    }
                ],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 0,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 48,
                                    "column": 52
                                },
                                "end": {
                                    "line": 48,
                                    "column": 62
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/lib/notifications.py",
                            "hunk_idx": 1,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": [
                    0
                ]
            },
            [
                "    return \"%s/%s\" % (user_profile.realm.uri.rstrip(\"/\"), resource_path)\n",
                "\n",
                "def hash_util_encode(string):\n",
                "    # type: (Text) -> Text\n",
                "    # Do the same encoding operation as hash_util.encodeHashComponent on the\n",
                "    # frontend.\n",
                "    # `safe` has a default value of \"/\", but we want those encoded, too.\n",
                "    return urllib.parse.quote(\n",
                "        string.encode(\"utf-8\"), safe=b\"\").replace(\".\", \"%2E\").replace(\"%\", \".\")\n",
                "\n",
                "def pm_narrow_url(realm, participants):\n",
                "    # type: (Realm, List[Text]) -> Text\n",
                "    participants.sort()\n",
                "    base_url = u\"%s/#narrow/pm-with/\" % (realm.uri,)\n",
                "    return base_url + hash_util_encode(\",\".join(participants))\n",
                "\n",
                "def stream_narrow_url(realm, stream):\n",
                "    # type: (Realm, Text) -> Text\n",
                "    base_url = u\"%s/#narrow/stream/\" % (realm.uri,)\n",
                "    return base_url + hash_util_encode(stream)\n",
                "\n",
                "def topic_narrow_url(realm, stream, topic):\n",
                "    # type: (Realm, Text, Text) -> Text\n",
                "    base_url = u\"%s/#narrow/stream/\" % (realm.uri,)\n",
                "    return u\"%s%s/topic/%s\" % (base_url, hash_util_encode(stream),\n",
                "                               hash_util_encode(topic))\n",
                "\n",
                "def build_message_list(user_profile, messages):\n",
                "    # type: (UserProfile, List[Message]) -> List[Dict[str, Any]]\n",
                "    \"\"\"\n",
                "    Builds the message list object for the missed message email template.\n",
                "    The messages are collapsed into per-recipient and per-sender blocks, like\n",
                "    our web interface\n",
                "    \"\"\"\n",
                "    messages_to_render = []  # type: List[Dict[str, Any]]\n",
                "\n",
                "    def sender_string(message):\n",
                "        # type: (Message) -> Text\n",
                "        if message.recipient.type in (Recipient.STREAM, Recipient.HUDDLE):\n",
                "            return message.sender.full_name\n",
                "        else:\n",
                "            return ''\n",
                "\n",
                "    def relative_to_full_url(content):\n",
                "        # type: (Text) -> Text\n",
                "        # URLs for uploaded content are of the form\n",
                "        # \"/user_uploads/abc.png\". Make them full paths.\n",
                "        #\n",
                "        # There's a small chance of colliding with non-Zulip URLs containing\n",
                "        # \"/user_uploads/\", but we don't have much information about the\n",
                "        # structure of the URL to leverage.\n",
                "        content = re.sub(\n",
                "            r\"/user_uploads/(\\S*)\",\n",
                "            user_profile.realm.uri + r\"/user_uploads/\\1\", content)\n",
                "\n",
                "        # Our proxying user-uploaded images seems to break inline images in HTML\n",
                "        # emails, so scrub the image but leave the link.\n",
                "        content = re.sub(\n",
                "            r\"<img src=(\\S+)/user_uploads/(\\S+)>\", \"\", content)\n",
                "\n",
                "        # URLs for emoji are of the form\n",
                "        # \"static/generated/emoji/images/emoji/snowflake.png\".\n",
                "        content = re.sub(\n",
                "            r\"/static/generated/emoji/images/emoji/\",\n",
                "            user_profile.realm.uri + r\"/static/generated/emoji/images/emoji/\",\n",
                "            content)\n",
                "\n",
                "        return content\n",
                "\n",
                "    def fix_plaintext_image_urls(content):\n",
                "        # type: (Text) -> Text\n",
                "        # Replace image URLs in plaintext content of the form\n",
                "        #     [image name](image url)\n",
                "        # with a simple hyperlink.\n",
                "        return re.sub(r\"\\[(\\S*)\\]\\((\\S*)\\)\", r\"\\2\", content)\n",
                "\n",
                "    def fix_emoji_sizes(html):\n",
                "        # type: (Text) -> Text\n",
                "        return html.replace(' class=\"emoji\"', ' height=\"20px\"')\n",
                "\n",
                "    def build_message_payload(message):\n",
                "        # type: (Message) -> Dict[str, Text]\n",
                "        plain = message.content\n",
                "        plain = fix_plaintext_image_urls(plain)\n",
                "        plain = relative_to_full_url(plain)\n",
                "\n",
                "        assert message.rendered_content is not None\n",
                "        html = message.rendered_content\n",
                "        html = relative_to_full_url(html)\n",
                "        html = fix_emoji_sizes(html)\n",
                "\n",
                "        return {'plain': plain, 'html': html}\n",
                "\n",
                "    def build_sender_payload(message):\n",
                "        # type: (Message) -> Dict[str, Any]\n",
                "        sender = sender_string(message)\n",
                "        return {'sender': sender,\n",
                "                'content': [build_message_payload(message)]}\n",
                "\n",
                "    def message_header(user_profile, message):\n",
                "        # type: (UserProfile, Message) -> Dict[str, Any]\n",
                "        disp_recipient = get_display_recipient(message.recipient)\n",
                "        if message.recipient.type == Recipient.PERSONAL:\n",
                "            header = u\"You and %s\" % (message.sender.full_name,)\n",
                "            html_link = pm_narrow_url(user_profile.realm, [message.sender.email])\n",
                "            header_html = u\"<a style='color: #ffffff;' href='%s'>%s</a>\" % (html_link, header)\n",
                "        elif message.recipient.type == Recipient.HUDDLE:\n",
                "            assert not isinstance(disp_recipient, Text)\n",
                "            other_recipients = [r['full_name'] for r in disp_recipient\n",
                "                                if r['email'] != user_profile.email]\n",
                "            header = u\"You and %s\" % (\", \".join(other_recipients),)\n",
                "            html_link = pm_narrow_url(user_profile.realm, [r[\"email\"] for r in disp_recipient\n",
                "                                      if r[\"email\"] != user_profile.email])\n",
                "            header_html = u\"<a style='color: #ffffff;' href='%s'>%s</a>\" % (html_link, header)\n",
                "        else:\n",
                "            assert isinstance(disp_recipient, Text)\n",
                "            header = u\"%s > %s\" % (disp_recipient, message.topic_name())\n",
                "            stream_link = stream_narrow_url(user_profile.realm, disp_recipient)\n",
                "            topic_link = topic_narrow_url(user_profile.realm, disp_recipient, message.subject)\n",
                "            header_html = u\"<a href='%s'>%s</a> > <a href='%s'>%s</a>\" % (\n",
                "                stream_link, disp_recipient, topic_link, message.subject)\n",
                "        return {\"plain\": header,\n",
                "                \"html\": header_html,\n",
                "                \"stream_message\": message.recipient.type_name() == \"stream\"}\n",
                "\n",
                "    # # Collapse message list to\n",
                "    # [\n",
                "    #    {\n",
                "    #       \"header\": {\n",
                "    #                   \"plain\":\"header\",\n",
                "    #                   \"html\":\"htmlheader\"\n",
                "    #                 }\n",
                "    #       \"senders\":[\n",
                "    #          {\n",
                "    #             \"sender\":\"sender_name\",\n",
                "    #             \"content\":[\n",
                "    #                {\n",
                "    #                   \"plain\":\"content\",\n",
                "    #                   \"html\":\"htmlcontent\"\n",
                "    #                }\n",
                "    #                {\n",
                "    #                   \"plain\":\"content\",\n",
                "    #                   \"html\":\"htmlcontent\"\n",
                "    #                }\n",
                "    #             ]\n",
                "    #          }\n",
                "    #       ]\n",
                "    #    },\n",
                "    # ]\n",
                "\n",
                "    messages.sort(key=lambda message: message.pub_date)\n",
                "\n",
                "    for message in messages:\n",
                "        header = message_header(user_profile, message)\n",
                "\n",
                "        # If we want to collapse into the previous recipient block\n",
                "        if len(messages_to_render) > 0 and messages_to_render[-1]['header'] == header:\n",
                "            sender = sender_string(message)\n",
                "            sender_block = messages_to_render[-1]['senders']\n",
                "\n",
                "            # Same message sender, collapse again\n",
                "            if sender_block[-1]['sender'] == sender:\n",
                "                sender_block[-1]['content'].append(build_message_payload(message))\n",
                "            else:\n",
                "                # Start a new sender block\n",
                "                sender_block.append(build_sender_payload(message))\n",
                "        else:\n",
                "            # New recipient and sender block\n",
                "            recipient_block = {'header': header,\n",
                "                               'senders': [build_sender_payload(message)]}\n",
                "\n",
                "            messages_to_render.append(recipient_block)\n",
                "\n",
                "    return messages_to_render\n",
                "\n",
                "@statsd_increment(\"missed_message_reminders\")\n",
                "def do_send_missedmessage_events_reply_in_zulip(user_profile, missed_messages, message_count):\n",
                "    # type: (UserProfile, List[Message], int) -> None\n",
                "    \"\"\"\n",
                "    Send a reminder email to a user if she's missed some PMs by being offline.\n",
                "\n",
                "    The email will have its reply to address set to a limited used email\n",
                "    address that will send a zulip message to the correct recipient. This\n",
                "    allows the user to respond to missed PMs, huddles, and @-mentions directly\n",
                "    from the email.\n",
                "\n",
                "    `user_profile` is the user to send the reminder to\n",
                "    `missed_messages` is a list of Message objects to remind about they should\n",
                "                      all have the same recipient and subject\n",
                "    \"\"\"\n",
                "    from zerver.context_processors import common_context\n",
                "    # Disabled missedmessage emails internally\n",
                "    if not user_profile.enable_offline_email_notifications:\n",
                "        return\n",
                "\n",
                "    recipients = set((msg.recipient_id, msg.subject) for msg in missed_messages)\n",
                "    if len(recipients) != 1:\n",
                "        raise ValueError(\n",
                "            'All missed_messages must have the same recipient and subject %r' %\n",
                "            recipients\n",
                "        )\n",
                "\n",
                "    unsubscribe_link = one_click_unsubscribe_link(user_profile, \"missed_messages\")\n",
                "    context = common_context(user_profile)\n",
                "    context.update({\n",
                "        'name': user_profile.full_name,\n",
                "        'messages': build_message_list(user_profile, missed_messages),\n",
                "        'message_count': message_count,\n",
                "        'mention': missed_messages[0].recipient.type == Recipient.STREAM,\n",
                "        'unsubscribe_link': unsubscribe_link,\n",
                "    })\n",
                "\n",
                "    # If this setting (email mirroring integration) is enabled, only then\n",
                "    # can users reply to email to send message to Zulip. Thus, one must\n",
                "    # ensure to display warning in the template.\n",
                "    if settings.EMAIL_GATEWAY_PATTERN:\n",
                "        context.update({\n",
                "            'reply_warning': False,\n",
                "            'reply_to_zulip': True,\n",
                "        })\n",
                "    else:\n",
                "        context.update({\n",
                "            'reply_warning': True,\n",
                "            'reply_to_zulip': False,\n",
                "        })\n",
                "\n",
                "    from zerver.lib.email_mirror import create_missed_message_address\n",
                "    reply_to_address = create_missed_message_address(user_profile, missed_messages[0])\n",
                "    if reply_to_address == FromAddress.NOREPLY:\n",
                "        reply_to_name = None\n",
                "    else:\n",
                "        reply_to_name = \"Zulip\"\n",
                "\n",
                "    senders = list(set(m.sender for m in missed_messages))\n",
                "    if (missed_messages[0].recipient.type == Recipient.HUDDLE):\n",
                "        display_recipient = get_display_recipient(missed_messages[0].recipient)\n",
                "        # Make sure that this is a list of strings, not a string.\n",
                "        assert not isinstance(display_recipient, Text)\n",
                "        other_recipients = [r['full_name'] for r in display_recipient\n",
                "                            if r['id'] != user_profile.id]\n",
                "        context.update({'group_pm': True})\n",
                "        if len(other_recipients) == 2:\n",
                "            huddle_display_name = u\"%s\" % (\" and \".join(other_recipients))\n",
                "            context.update({'huddle_display_name': huddle_display_name})\n",
                "        elif len(other_recipients) == 3:\n",
                "            huddle_display_name = u\"%s, %s, and %s\" % (other_recipients[0], other_recipients[1], other_recipients[2])\n",
                "            context.update({'huddle_display_name': huddle_display_name})\n",
                "        else:\n",
                "            huddle_display_name = u\"%s, and %s others\" % (', '.join(other_recipients[:2]), len(other_recipients) - 2)\n",
                "            context.update({'huddle_display_name': huddle_display_name})\n",
                "    elif (missed_messages[0].recipient.type == Recipient.PERSONAL):\n",
                "        context.update({'private_message': True})\n",
                "    else:\n",
                "        # Keep only the senders who actually mentioned the user\n",
                "        #\n",
                "        # TODO: When we add wildcard mentions that send emails, add\n",
                "        # them to the filter here.\n",
                "        senders = list(set(m.sender for m in missed_messages if\n",
                "                           UserMessage.objects.filter(message=m, user_profile=user_profile,\n",
                "                                                      flags=UserMessage.flags.mentioned).exists()))\n",
                "        context.update({'at_mention': True})\n",
                "\n",
                "    context.update({\n",
                "        'sender_str': \", \".join(sender.full_name for sender in senders),\n",
                "        'realm_str': user_profile.realm.name,\n",
                "    })\n",
                "\n",
                "    from_name, from_address = None, None\n",
                "    if len(senders) == 1 and settings.SEND_MISSED_MESSAGE_EMAILS_AS_USER:\n",
                "        # If this setting is enabled, you can reply to the Zulip\n",
                "        # missed message emails directly back to the original sender.\n",
                "        # However, one must ensure the Zulip server is in the SPF\n",
                "        # record for the domain, or there will be spam/deliverability\n",
                "        # problems.\n",
                "        sender = senders[0]\n",
                "        from_name, from_address = (sender.full_name, sender.email)\n",
                "        context.update({\n",
                "            'reply_warning': False,\n",
                "            'reply_to_zulip': False,\n",
                "        })\n",
                "\n",
                "    email_dict = {\n",
                "        'template_prefix': 'zerver/emails/missed_message',\n",
                "        'to_email': display_email(user_profile),\n",
                "        'from_name': from_name,\n",
                "        'from_address': from_address,\n",
                "        'reply_to_email': formataddr((reply_to_name, reply_to_address)),\n",
                "        'context': context}\n",
                "    queue_json_publish(\"missedmessage_email_senders\", email_dict, send_email_from_dict)\n",
                "\n",
                "    user_profile.last_reminder = timezone_now()\n",
                "    user_profile.save(update_fields=['last_reminder'])\n",
                "\n",
                "def handle_missedmessage_emails(user_profile_id, missed_email_events):\n",
                "    # type: (int, Iterable[Dict[str, Any]]) -> None\n",
                "    message_ids = [event.get('message_id') for event in missed_email_events]\n",
                "\n",
                "    user_profile = get_user_profile_by_id(user_profile_id)\n",
                "    if not receives_offline_notifications(user_profile):\n",
                "        return\n",
                "\n",
                "    messages = Message.objects.filter(usermessage__user_profile_id=user_profile,\n",
                "                                      id__in=message_ids,\n",
                "                                      usermessage__flags=~UserMessage.flags.read)\n",
                "\n",
                "    # Cancel missed-message emails for deleted messages\n",
                "    messages = [um for um in messages if um.content != \"(deleted)\"]\n",
                "\n",
                "    if not messages:\n",
                "        return\n",
                "\n",
                "    messages_by_recipient_subject = defaultdict(list)  # type: Dict[Tuple[int, Text], List[Message]]\n",
                "    for msg in messages:\n",
                "        messages_by_recipient_subject[(msg.recipient_id, msg.topic_name())].append(msg)\n",
                "\n",
                "    message_count_by_recipient_subject = {\n",
                "        recipient_subject: len(msgs)\n",
                "        for recipient_subject, msgs in messages_by_recipient_subject.items()\n",
                "    }\n",
                "\n",
                "    for msg_list in messages_by_recipient_subject.values():\n",
                "        msg = min(msg_list, key=lambda msg: msg.pub_date)\n",
                "        if msg.recipient.type == Recipient.STREAM:\n",
                "            msg_list.extend(get_context_for_message(msg))\n",
                "\n",
                "    # Send an email per recipient subject pair\n",
                "    for recipient_subject, msg_list in messages_by_recipient_subject.items():\n",
                "        unique_messages = {m.id: m for m in msg_list}\n",
                "        do_send_missedmessage_events_reply_in_zulip(\n",
                "            user_profile,\n",
                "            list(unique_messages.values()),\n",
                "            message_count_by_recipient_subject[recipient_subject],\n",
                "        )\n",
                "\n",
                "def clear_followup_emails_queue(email):\n",
                "    # type: (Text) -> None\n",
                "    \"\"\"\n",
                "    Clear out queued emails that would otherwise be sent to a specific email address.\n",
                "    \"\"\"\n",
                "    items = ScheduledJob.objects.filter(type=ScheduledJob.EMAIL, filter_string__iexact = email)\n",
                "    items.delete()\n",
                "\n",
                "def log_digest_event(msg):\n",
                "    # type: (Text) -> None\n",
                "    import logging\n",
                "    logging.basicConfig(filename=settings.DIGEST_LOG_PATH, level=logging.INFO)\n",
                "    logging.info(msg)\n",
                "\n",
                "def enqueue_welcome_emails(email, name):\n",
                "    # type: (Text, Text) -> None\n",
                "    from zerver.context_processors import common_context\n",
                "    if settings.WELCOME_EMAIL_SENDER is not None:\n",
                "        # line break to avoid triggering lint rule\n",
                "        from_name = settings.WELCOME_EMAIL_SENDER['name']\n",
                "        from_address = settings.WELCOME_EMAIL_SENDER['email']\n",
                "    else:\n",
                "        from_name = None\n",
                "        from_address = FromAddress.SUPPORT\n",
                "\n",
                "    user_profile = get_user_profile_by_email(email)\n",
                "    unsubscribe_link = one_click_unsubscribe_link(user_profile, \"welcome\")\n",
                "    context = common_context(user_profile)\n",
                "    context.update({\n",
                "        'unsubscribe_link': unsubscribe_link\n",
                "    })\n",
                "    send_future_email(\n",
                "        \"zerver/emails/followup_day1\", '%s <%s>' % (name, email), from_name=from_name,\n",
                "        from_address=from_address, context=context, delay=datetime.timedelta(hours=1))\n",
                "    send_future_email(\n",
                "        \"zerver/emails/followup_day2\", '%s <%s>' % (name, email), from_name=from_name,\n",
                "        from_address=from_address, context=context, delay=datetime.timedelta(days=1))\n",
                "\n",
                "def convert_html_to_markdown(html):\n",
                "    # type: (Text) -> Text\n",
                "    # On Linux, the tool installs as html2markdown, and there's a command called\n",
                "    # html2text that does something totally different. On OSX, the tool installs\n",
                "    # as html2text.\n",
                "    commands = [\"html2markdown\", \"html2text\"]\n",
                "\n",
                "    for command in commands:\n",
                "        try:\n",
                "            # A body width of 0 means do not try to wrap the text for us.\n",
                "            p = subprocess.Popen(\n",
                "                [command, \"--body-width=0\"], stdout=subprocess.PIPE,\n",
                "                stdin=subprocess.PIPE, stderr=subprocess.STDOUT)\n",
                "            break\n",
                "        except OSError:\n",
                "            continue\n",
                "\n",
                "    markdown = p.communicate(input=html.encode('utf-8'))[0].decode('utf-8').strip()\n",
                "    # We want images to get linked and inline previewed, but html2text will turn\n",
                "    # them into links of the form `![](http://foo.com/image.png)`, which is\n",
                "    # ugly. Run a regex over the resulting description, turning links of the\n",
                "    # form `![](http://foo.com/image.png?12345)` into\n",
                "    # `[image.png](http://foo.com/image.png)`.\n",
                "    return re.sub(u\"!\\\\[\\\\]\\\\((\\\\S*)/(\\\\S*)\\\\?(\\\\S*)\\\\)\",\n",
                "                  u\"[\\\\2](\\\\1/\\\\2)\", markdown)"
            ]
        ],
        "zerver/views/unsubscribe.py": [
            [
                "from __future__ import absolute_import\n",
                "\n",
                "from django.conf import settings\n",
                "from django.http import HttpRequest, HttpResponse\n",
                "from django.shortcuts import render\n",
                "from typing import Callable\n",
                "\n",
                "from confirmation.models import Confirmation\n",
                "from zerver.lib.actions import do_change_notification_settings, clear_followup_emails_queue\n",
                "from zerver.models import UserProfile\n",
                "from zerver.context_processors import common_context\n",
                "\n",
                "def process_unsubscribe(request, token, subscription_type, unsubscribe_function):\n",
                "    # type: (HttpRequest, str, str, Callable[[UserProfile], None]) -> HttpResponse\n",
                "    try:\n",
                "        confirmation = Confirmation.objects.get(confirmation_key=token)\n",
                "    except Confirmation.DoesNotExist:\n",
                "        return render(request, 'zerver/unsubscribe_link_error.html')\n",
                "\n",
                "    user_profile = confirmation.content_object\n",
                "    unsubscribe_function(user_profile)\n",
                "    context = common_context(user_profile)\n",
                "    context.update({\"subscription_type\": subscription_type})\n",
                "    return render(request, 'zerver/unsubscribe_success.html', context=context)\n",
                "\n",
                "# Email unsubscribe functions. All have the function signature\n",
                "# processor(user_profile).\n",
                "\n",
                "def do_missedmessage_unsubscribe(user_profile):\n",
                "    # type: (UserProfile) -> None\n",
                "    do_change_notification_settings(user_profile, 'enable_offline_email_notifications', False)\n",
                "\n",
                "def do_welcome_unsubscribe(user_profile):\n",
                "    # type: (UserProfile) -> None\n",
                "    clear_followup_emails_queue(user_profile.email)\n",
                "\n",
                "def do_digest_unsubscribe(user_profile):\n",
                "    # type: (UserProfile) -> None\n",
                "    do_change_notification_settings(user_profile, 'enable_digest_emails', False)\n",
                "\n",
                "# The keys are part of the URL for the unsubscribe link and must be valid\n",
                "# without encoding.\n",
                "# The values are a tuple of (display name, unsubscribe function), where the\n",
                "# display name is what we call this class of email in user-visible text.\n",
                "email_unsubscribers = {\n",
                "    \"missed_messages\": (\"missed messages\", do_missedmessage_unsubscribe),\n",
                "    \"welcome\": (\"welcome\", do_welcome_unsubscribe),\n",
                "    \"digest\": (\"digest\", do_digest_unsubscribe)\n",
                "}\n",
                "\n",
                "# Login NOT required. These are for one-click unsubscribes.\n"
            ],
            {
                "type": "replace",
                "before": [
                    "def email_unsubscribe(request, type, token):\n"
                ],
                "after": [
                    "def email_unsubscribe(request, email_type, confirmation_key):\n"
                ],
                "parent_version_range": {
                    "start": 51,
                    "end": 52
                },
                "child_version_range": {
                    "start": 51,
                    "end": 52
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "email_unsubscribe",
                        "signature": "def email_unsubscribe(request, type, token):",
                        "at_line": 51
                    }
                ],
                "idx": 2,
                "hunk_diff": "File: zerver/views/unsubscribe.py\nCode:\n48 48    }\n49 49    \n50 50    # Login NOT required. These are for one-click unsubscribes.\n51     - def email_unsubscribe(request, type, token):\n   51  + def email_unsubscribe(request, email_type, confirmation_key):\n52 52        # type: (HttpRequest, str, str) -> HttpResponse\n       ...\n",
                "file_path": "zerver/views/unsubscribe.py",
                "identifiers_before": [
                    "email_unsubscribe",
                    "request",
                    "token",
                    "type"
                ],
                "identifiers_after": [
                    "confirmation_key",
                    "email_type",
                    "email_unsubscribe",
                    "request"
                ],
                "prefix": [
                    "}\n",
                    "\n",
                    "# Login NOT required. These are for one-click unsubscribes.\n"
                ],
                "suffix": [
                    "    # type: (HttpRequest, str, str) -> HttpResponse\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "request",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 22
                                },
                                "end": {
                                    "line": 51,
                                    "column": 29
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "type",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 31
                                },
                                "end": {
                                    "line": 51,
                                    "column": 35
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "type",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 31
                                },
                                "end": {
                                    "line": 51,
                                    "column": 35
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "token",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 37
                                },
                                "end": {
                                    "line": 51,
                                    "column": 42
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "request",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 22
                                },
                                "end": {
                                    "line": 51,
                                    "column": 29
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 31
                                },
                                "end": {
                                    "line": 51,
                                    "column": 41
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 31
                                },
                                "end": {
                                    "line": 51,
                                    "column": 41
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "confirmation_key",
                            "position": {
                                "start": {
                                    "line": 51,
                                    "column": 43
                                },
                                "end": {
                                    "line": 51,
                                    "column": 59
                                }
                            },
                            "type": "identifier",
                            "kind": "parameter",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "    # type: (HttpRequest, str, str) -> HttpResponse\n"
            ],
            {
                "type": "replace",
                "before": [
                    "    if type in email_unsubscribers:\n",
                    "        display_name, unsubscribe_function = email_unsubscribers[type]\n",
                    "        return process_unsubscribe(request, token, display_name, unsubscribe_function)\n"
                ],
                "after": [
                    "    if email_type in email_unsubscribers:\n",
                    "        display_name, unsubscribe_function = email_unsubscribers[email_type]\n",
                    "        return process_unsubscribe(request, confirmation_key, display_name, unsubscribe_function)\n"
                ],
                "parent_version_range": {
                    "start": 53,
                    "end": 56
                },
                "child_version_range": {
                    "start": 53,
                    "end": 56
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if type in email_unsubscribers:",
                        "start_line": 53,
                        "end_line": 55
                    }
                ],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "email_unsubscribe",
                        "signature": "def email_unsubscribe(request, type, token):",
                        "at_line": 51
                    }
                ],
                "idx": 3,
                "hunk_diff": "File: zerver/views/unsubscribe.py\nCode:\n         def email_unsubscribe(request, type, token):\n             ...\n52 52        # type: (HttpRequest, str, str) -> HttpResponse\n53     -     if type in email_unsubscribers:\n54     -         display_name, unsubscribe_function = email_unsubscribers[type]\n55     -         return process_unsubscribe(request, token, display_name, unsubscribe_function)\n   53  +     if email_type in email_unsubscribers:\n   54  +         display_name, unsubscribe_function = email_unsubscribers[email_type]\n   55  +         return process_unsubscribe(request, confirmation_key, display_name, unsubscribe_function)\n56 56    \n57 57        return render(request, 'zerver/unsubscribe_link_error.html')\n       ...\n",
                "file_path": "zerver/views/unsubscribe.py",
                "identifiers_before": [
                    "display_name",
                    "email_unsubscribers",
                    "process_unsubscribe",
                    "request",
                    "token",
                    "type",
                    "unsubscribe_function"
                ],
                "identifiers_after": [
                    "confirmation_key",
                    "display_name",
                    "email_type",
                    "email_unsubscribers",
                    "process_unsubscribe",
                    "request",
                    "unsubscribe_function"
                ],
                "prefix": [
                    "    # type: (HttpRequest, str, str) -> HttpResponse\n"
                ],
                "suffix": [
                    "\n",
                    "    return render(request, 'zerver/unsubscribe_link_error.html')"
                ],
                "base_dependency_callee": [
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "request",
                            "position": {
                                "start": {
                                    "line": 55,
                                    "column": 35
                                },
                                "end": {
                                    "line": 55,
                                    "column": 42
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "type",
                            "position": {
                                "start": {
                                    "line": 53,
                                    "column": 7
                                },
                                "end": {
                                    "line": 53,
                                    "column": 11
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "type",
                            "position": {
                                "start": {
                                    "line": 54,
                                    "column": 65
                                },
                                "end": {
                                    "line": 54,
                                    "column": 69
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "token",
                            "position": {
                                "start": {
                                    "line": 55,
                                    "column": 44
                                },
                                "end": {
                                    "line": 55,
                                    "column": 49
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    }
                ],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "request",
                            "position": {
                                "start": {
                                    "line": 55,
                                    "column": 35
                                },
                                "end": {
                                    "line": 55,
                                    "column": 42
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 53,
                                    "column": 7
                                },
                                "end": {
                                    "line": 53,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "email_type",
                            "position": {
                                "start": {
                                    "line": 54,
                                    "column": 65
                                },
                                "end": {
                                    "line": 54,
                                    "column": 75
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "confirmation_key",
                            "position": {
                                "start": {
                                    "line": 55,
                                    "column": 44
                                },
                                "end": {
                                    "line": 55,
                                    "column": 60
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/zulip/zerver/views/unsubscribe.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "\n",
                "    return render(request, 'zerver/unsubscribe_link_error.html')"
            ]
        ],
        "zproject/urls.py": [
            [
                "from django.conf import settings\n",
                "from django.conf.urls import url, include\n",
                "from django.conf.urls.i18n import i18n_patterns\n",
                "from django.views.generic import TemplateView, RedirectView\n",
                "from django.utils.module_loading import import_string\n",
                "import os.path\n",
                "import zerver.forms\n",
                "from zproject import dev_urls\n",
                "from zproject.legacy_urls import legacy_urls\n",
                "from zerver.views.integrations import IntegrationView, APIView, HelpView\n",
                "from zerver.lib.integrations import WEBHOOK_INTEGRATIONS\n",
                "from zerver.webhooks import github_dispatcher\n",
                "\n",
                "\n",
                "from django.contrib.auth.views import (login, password_reset,\n",
                "                                       password_reset_done, password_reset_confirm, password_reset_complete)\n",
                "\n",
                "import zerver.tornado.views\n",
                "import zerver.views\n",
                "import zerver.views.auth\n",
                "import zerver.views.compatibility\n",
                "import zerver.views.home\n",
                "import zerver.views.email_mirror\n",
                "import zerver.views.registration\n",
                "import zerver.views.zephyr\n",
                "import zerver.views.users\n",
                "import zerver.views.unsubscribe\n",
                "import zerver.views.integrations\n",
                "import zerver.views.user_settings\n",
                "import zerver.views.muting\n",
                "import zerver.views.streams\n",
                "import confirmation.views\n",
                "\n",
                "from zerver.lib.rest import rest_dispatch\n",
                "\n",
                "# NB: There are several other pieces of code which route requests by URL:\n",
                "#\n",
                "#   - legacy_urls.py contains API endpoint written before the redesign\n",
                "#     and should not be added to.\n",
                "#\n",
                "#   - runtornado.py has its own URL list for Tornado views.  See the\n",
                "#     invocation of web.Application in that file.\n",
                "#\n",
                "#   - The Nginx config knows which URLs to route to Django or Tornado.\n",
                "#\n",
                "#   - Likewise for the local dev server in tools/run-dev.py.\n",
                "\n",
                "# These views serve pages (HTML). As such, their internationalization\n",
                "# must depend on the url.\n",
                "#\n",
                "# If you're adding a new page to the website (as opposed to a new\n",
                "# endpoint for use by code), you should add it here.\n",
                "i18n_urls = [\n",
                "    url(r'^$', zerver.views.home.home, name='zerver.views.home.home'),\n",
                "    # We have a desktop-specific landing page in case we change our /\n",
                "    # to not log in in the future. We don't want to require a new\n",
                "    # desktop app build for everyone in that case\n",
                "    url(r'^desktop_home/$', zerver.views.home.desktop_home, name='zerver.views.home.desktop_home'),\n",
                "\n",
                "    url(r'^accounts/login/sso/$', zerver.views.auth.remote_user_sso, name='login-sso'),\n",
                "    url(r'^accounts/login/jwt/$', zerver.views.auth.remote_user_jwt, name='login-jwt'),\n",
                "    url(r'^accounts/login/social/(\\w+)$', zerver.views.auth.start_social_login, name='login-social'),\n",
                "    url(r'^accounts/login/google/$', zerver.views.auth.start_google_oauth2, name='zerver.views.auth.start_google_oauth2'),\n",
                "    url(r'^accounts/login/google/send/$',\n",
                "        zerver.views.auth.send_oauth_request_to_google,\n",
                "        name='zerver.views.auth.send_oauth_request_to_google'),\n",
                "    url(r'^accounts/login/google/done/$', zerver.views.auth.finish_google_oauth2, name='zerver.views.auth.finish_google_oauth2'),\n",
                "    url(r'^accounts/login/subdomain/$', zerver.views.auth.log_into_subdomain, name='zerver.views.auth.log_into_subdomain'),\n",
                "    url(r'^accounts/login/local/$', zerver.views.auth.dev_direct_login, name='zerver.views.auth.dev_direct_login'),\n",
                "    # We have two entries for accounts/login to allow reverses on the Django\n",
                "    # view we're wrapping to continue to function.\n",
                "    url(r'^accounts/login/', zerver.views.auth.login_page, {'template_name': 'zerver/login.html'}, name='zerver.views.auth.login_page'),\n",
                "    url(r'^accounts/login/', login, {'template_name': 'zerver/login.html'},\n",
                "        name='django.contrib.auth.views.login'),\n",
                "    url(r'^accounts/logout/', zerver.views.auth.logout_then_login, name='zerver.views.auth.logout_then_login'),\n",
                "\n",
                "    url(r'^accounts/webathena_kerberos_login/',\n",
                "        zerver.views.zephyr.webathena_kerberos_login,\n",
                "        name='zerver.views.zephyr.webathena_kerberos_login'),\n",
                "\n",
                "    url(r'^accounts/password/reset/$', password_reset,\n",
                "        {'post_reset_redirect': '/accounts/password/reset/done/',\n",
                "         'template_name': 'zerver/reset.html',\n",
                "         'email_template_name': '',\n",
                "         'subject_template_name': '',\n",
                "         'password_reset_form': zerver.forms.ZulipPasswordResetForm,\n",
                "         }, name='django.contrib.auth.views.password_reset'),\n",
                "    url(r'^accounts/password/reset/done/$', password_reset_done,\n",
                "        {'template_name': 'zerver/reset_emailed.html'}),\n",
                "    url(r'^accounts/password/reset/(?P<uidb64>[0-9A-Za-z]+)/(?P<token>.+)/$',\n",
                "        password_reset_confirm,\n",
                "        {'post_reset_redirect': '/accounts/password/done/',\n",
                "         'template_name': 'zerver/reset_confirm.html',\n",
                "         'set_password_form': zerver.forms.LoggingSetPasswordForm},\n",
                "        name='django.contrib.auth.views.password_reset_confirm'),\n",
                "    url(r'^accounts/password/done/$', password_reset_complete,\n",
                "        {'template_name': 'zerver/reset_done.html'}),\n",
                "\n",
                "    # Avatar\n",
                "    url(r'^avatar/(?P<email_or_id>[\\S]+)?/(?P<medium>[\\S]+)?', zerver.views.users.avatar, name='zerver.views.users.avatar'),\n",
                "    url(r'^avatar/(?P<email_or_id>[\\S]+)?', zerver.views.users.avatar, name='zerver.views.users.avatar'),\n",
                "\n",
                "    # Registration views, require a confirmation ID.\n",
                "    url(r'^accounts/register/social/(\\w+)$',\n",
                "        zerver.views.auth.start_social_signup,\n",
                "        name='signup-social'),\n",
                "    url(r'^accounts/home/', zerver.views.registration.accounts_home,\n",
                "        name='zerver.views.registration.accounts_home'),\n",
                "    url(r'^accounts/send_confirm/(?P<email>[\\S]+)?',\n",
                "        TemplateView.as_view(template_name='zerver/accounts_send_confirm.html'), name='send_confirm'),\n",
                "    url(r'^accounts/register/', zerver.views.registration.accounts_register,\n",
                "        name='zerver.views.registration.accounts_register'),\n",
                "    url(r'^accounts/do_confirm/(?P<confirmation_key>[\\w]+)', confirmation.views.confirm, name='confirmation.views.confirm'),\n",
                "\n",
                "    url(r'^accounts/confirm_new_email/(?P<confirmation_key>[\\w]+)',\n",
                "        zerver.views.user_settings.confirm_email_change,\n",
                "        name='zerver.views.user_settings.confirm_email_change'),\n",
                "\n",
                "    # Email unsubscription endpoint. Allows for unsubscribing from various types of emails,\n",
                "    # including the welcome emails (day 1 & 2), missed PMs, etc.\n"
            ],
            {
                "type": "replace",
                "before": [
                    "    url(r'^accounts/unsubscribe/(?P<type>[\\w]+)/(?P<token>[\\w]+)',\n"
                ],
                "after": [
                    "    url(r'^accounts/unsubscribe/(?P<email_type>[\\w]+)/(?P<confirmation_key>[\\w]+)',\n"
                ],
                "parent_version_range": {
                    "start": 120,
                    "end": 121
                },
                "child_version_range": {
                    "start": 120,
                    "end": 121
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "call",
                        "name": "url",
                        "signature": "url(r'^accounts/unsubscribe/(?P<type>[\\w]+)/(?P<token>[\\w]+)',\n        zerver.views.unsubscribe.email_unsubscribe, name='zerver.views.unsubscribe.email_unsubscribe')",
                        "at_line": 120,
                        "argument": "r'^accounts/unsubscribe/(?P<ty..."
                    }
                ],
                "idx": 4,
                "hunk_diff": "File: zproject/urls.py\nCode:\n117 117    \n118 118        # Email unsubscription endpoint. Allows for unsubscribing from various types of emails,\n119 119        # including the welcome emails (day 1 & 2), missed PMs, etc.\n120      -     url(r'^accounts/unsubscribe/(?P<type>[\\w]+)/(?P<token>[\\w]+)',\n    120  +     url(r'^accounts/unsubscribe/(?P<email_type>[\\w]+)/(?P<confirmation_key>[\\w]+)',\n121 121            zerver.views.unsubscribe.email_unsubscribe, name='zerver.views.unsubscribe.email_unsubscribe'),\n122 122    \n123 123        # Portico-styled page used to provide email confirmation of terms acceptance.\n         ...\n",
                "file_path": "zproject/urls.py",
                "identifiers_before": [
                    "url"
                ],
                "identifiers_after": [
                    "url"
                ],
                "prefix": [
                    "\n",
                    "    # Email unsubscription endpoint. Allows for unsubscribing from various types of emails,\n",
                    "    # including the welcome emails (day 1 & 2), missed PMs, etc.\n"
                ],
                "suffix": [
                    "        zerver.views.unsubscribe.email_unsubscribe, name='zerver.views.unsubscribe.email_unsubscribe'),\n",
                    "\n",
                    "    # Portico-styled page used to provide email confirmation of terms acceptance.\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "        zerver.views.unsubscribe.email_unsubscribe, name='zerver.views.unsubscribe.email_unsubscribe'),\n",
                "\n",
                "    # Portico-styled page used to provide email confirmation of terms acceptance.\n",
                "    url(r'^accounts/accept_terms/$', zerver.views.home.accounts_accept_terms, name='zerver.views.home.accounts_accept_terms'),\n",
                "\n",
                "    # Realm Creation\n",
                "    url(r'^create_realm/$', zerver.views.registration.create_realm, name='zerver.views.create_realm'),\n",
                "    url(r'^create_realm/(?P<creation_key>[\\w]+)$', zerver.views.registration.create_realm, name='zerver.views.create_realm'),\n",
                "\n",
                "    # Login/registration\n",
                "    url(r'^register/$', zerver.views.registration.accounts_home, name='register'),\n",
                "    url(r'^login/$', zerver.views.auth.login_page, {'template_name': 'zerver/login.html'}, name='zerver.views.auth.login_page'),\n",
                "\n",
                "    # A registration page that passes through the Realm.string_id, for totally open realms.\n",
                "    url(r'^register/(?P<realm_str>\\S+)/$', zerver.views.registration.accounts_home_with_realm_str,\n",
                "        name='zerver.views.registration.accounts_home_with_realm_str'),\n",
                "\n",
                "    # API and integrations documentation\n",
                "    url(r'^api/$', APIView.as_view(template_name='zerver/api.html')),\n",
                "    url(r'^api/endpoints/$', zerver.views.integrations.api_endpoint_docs, name='zerver.views.integrations.api_endpoint_docs'),\n",
                "    url(r'^integrations/$', IntegrationView.as_view()),\n",
                "    url(r'^about/$', TemplateView.as_view(template_name='zerver/about.html')),\n",
                "    url(r'^apps/$', zerver.views.home.apps_view, name='zerver.views.home.apps_view'),\n",
                "\n",
                "    url(r'^robots\\.txt$', RedirectView.as_view(url='/static/robots.txt', permanent=True)),\n",
                "\n",
                "    # Landing page, features pages, signup form, etc.\n",
                "    url(r'^hello/$', TemplateView.as_view(template_name='zerver/hello.html'), name='landing-page'),\n",
                "    url(r'^new-user/$', RedirectView.as_view(url='/hello', permanent=True)),\n",
                "    url(r'^features/$', TemplateView.as_view(template_name='zerver/features.html')),\n",
                "    url(r'^for/open-source/$', TemplateView.as_view(template_name='zerver/for-open-source.html')),\n",
                "    url(r'^find_my_team/$', zerver.views.registration.find_my_team, name='zerver.views.registration.find_my_team'),\n",
                "    url(r'^authors/$', zerver.views.users.authors_view, name='zerver.views.users.authors_view'),\n",
                "\n",
                "    # Terms of service and privacy pages.\n",
                "    url(r'^terms/$', TemplateView.as_view(template_name='zerver/terms.html'), name='terms'),\n",
                "    url(r'^privacy/$', TemplateView.as_view(template_name='zerver/privacy.html'), name='privacy'),\n",
                "]\n",
                "\n",
                "# Make a copy of i18n_urls so that they appear without prefix for english\n",
                "urls = list(i18n_urls)\n",
                "\n",
                "# These endpoints constitute the redesigned API (V1), which uses:\n",
                "# * REST verbs\n",
                "# * Basic auth (username:password is email:apiKey)\n",
                "# * Take and return json-formatted data\n",
                "#\n",
                "# If you're adding a new endpoint to the code that requires authentication,\n",
                "# please add it here.\n",
                "# See rest_dispatch in zerver.lib.rest for an explanation of auth methods used\n",
                "#\n",
                "# All of these paths are accessed by either a /json or /api/v1 prefix\n",
                "v1_api_and_json_patterns = [\n",
                "    # realm-level calls\n",
                "    url(r'^realm$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.realm.update_realm'}),\n",
                "\n",
                "    # Returns a 204, used by desktop app to verify connectivity status\n",
                "    url(r'generate_204$', zerver.views.registration.generate_204, name='zerver.views.registration.generate_204'),\n",
                "\n",
                "    # realm/domains -> zerver.views.realm_domains\n",
                "    url(r'^realm/domains$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.realm_domains.list_realm_domains',\n",
                "         'POST': 'zerver.views.realm_domains.create_realm_domain'}),\n",
                "    url(r'^realm/domains/(?P<domain>\\S+)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.realm_domains.patch_realm_domain',\n",
                "         'DELETE': 'zerver.views.realm_domains.delete_realm_domain'}),\n",
                "\n",
                "    # realm/emoji -> zerver.views.realm_emoji\n",
                "    url(r'^realm/emoji$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.realm_emoji.list_emoji'}),\n",
                "    url(r'^realm/emoji/(?P<emoji_name>.*)$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.realm_emoji.upload_emoji',\n",
                "         'DELETE': 'zerver.views.realm_emoji.delete_emoji'}),\n",
                "\n",
                "    # realm/icon -> zerver.views.realm_icon\n",
                "    url(r'^realm/icon$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.realm_icon.upload_icon',\n",
                "         'DELETE': 'zerver.views.realm_icon.delete_icon_backend',\n",
                "         'GET': 'zerver.views.realm_icon.get_icon_backend'}),\n",
                "\n",
                "    # realm/filters -> zerver.views.realm_filters\n",
                "    url(r'^realm/filters$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.realm_filters.list_filters',\n",
                "         'POST': 'zerver.views.realm_filters.create_filter'}),\n",
                "    url(r'^realm/filters/(?P<filter_id>\\d+)$', rest_dispatch,\n",
                "        {'DELETE': 'zerver.views.realm_filters.delete_filter'}),\n",
                "\n",
                "    # realm/profile_fields -> zerver.views.custom_profile_fields\n",
                "    url(r'^realm/profile_fields$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.custom_profile_fields.list_realm_custom_profile_fields',\n",
                "         'POST': 'zerver.views.custom_profile_fields.create_realm_custom_profile_field'}),\n",
                "    url(r'^realm/profile_fields/(?P<field_id>\\d+)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.custom_profile_fields.update_realm_custom_profile_field',\n",
                "         'DELETE': 'zerver.views.custom_profile_fields.delete_realm_custom_profile_field'}),\n",
                "\n",
                "    # users -> zerver.views.users\n",
                "    #\n",
                "    # Since some of these endpoints do something different if used on\n",
                "    # yourself with `/me` as the email, we need to make sure that we\n",
                "    # don't accidentally trigger these.  The cleanest way to do that\n",
                "    # is to add a regular expression assertion that it isn't `/me/`\n",
                "    # (or ends with `/me`, in the case of hitting the root URL).\n",
                "    url(r'^users$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.users.get_members_backend',\n",
                "         'POST': 'zerver.views.users.create_user_backend'}),\n",
                "    url(r'^users/(?!me/)(?P<email>[^/]*)/reactivate$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.users.reactivate_user_backend'}),\n",
                "    url(r'^users/(?!me/)(?P<email>[^/]*)/presence$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.presence.get_presence_backend'}),\n",
                "    url(r'^users/(?!me$)(?P<email>[^/]*)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.users.update_user_backend',\n",
                "         'DELETE': 'zerver.views.users.deactivate_user_backend'}),\n",
                "    url(r'^bots$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.users.get_bots_backend',\n",
                "         'POST': 'zerver.views.users.add_bot_backend'}),\n",
                "    url(r'^bots/(?!me/)(?P<email>[^/]*)/api_key/regenerate$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.users.regenerate_bot_api_key'}),\n",
                "    url(r'^bots/(?!me/)(?P<email>[^/]*)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.users.patch_bot_backend',\n",
                "         'DELETE': 'zerver.views.users.deactivate_bot_backend'}),\n",
                "\n",
                "    # messages -> zerver.views.messages\n",
                "    # GET returns messages, possibly filtered, POST sends a message\n",
                "    url(r'^messages$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.messages.get_messages_backend',\n",
                "         'POST': 'zerver.views.messages.send_message_backend'}),\n",
                "    url(r'^messages/(?P<message_id>[0-9]+)$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.messages.json_fetch_raw_message',\n",
                "         'PATCH': 'zerver.views.messages.update_message_backend',\n",
                "         'DELETE': 'zerver.views.messages.delete_message_backend'}),\n",
                "    url(r'^messages/render$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.messages.render_message_backend'}),\n",
                "    url(r'^messages/flags$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.messages.update_message_flags'}),\n",
                "    url(r'^messages/(?P<message_id>\\d+)/history$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.messages.get_message_edit_history'}),\n",
                "\n",
                "    url(r'^users/me/subscriptions/properties$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.streams.update_subscription_properties_backend'}),\n",
                "\n",
                "    url(r'users/me/subscriptions/(?P<stream_id>\\d+)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.streams.update_subscriptions_property'}),\n",
                "\n",
                "    # reactions -> zerver.view.reactions\n",
                "    # PUT adds a reaction to a message\n",
                "    # DELETE removes a reaction from a message\n",
                "    url(r'^messages/(?P<message_id>[0-9]+)/emoji_reactions/(?P<emoji_name>.*)$',\n",
                "        rest_dispatch,\n",
                "        {'PUT': 'zerver.views.reactions.add_reaction_backend',\n",
                "         'DELETE': 'zerver.views.reactions.remove_reaction_backend'}),\n",
                "\n",
                "    # attachments -> zerver.views.attachments\n",
                "    url(r'^attachments$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.attachments.list_by_user'}),\n",
                "    url(r'^attachments/(?P<attachment_id>[0-9]+)$', rest_dispatch,\n",
                "        {'DELETE': 'zerver.views.attachments.remove'}),\n",
                "\n",
                "    # typing -> zerver.views.typing\n",
                "    # POST sends a typing notification event to recipients\n",
                "    url(r'^typing$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.typing.send_notification_backend'}),\n",
                "\n",
                "    # user_uploads -> zerver.views.upload\n",
                "    url(r'^user_uploads$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.upload.upload_file_backend'}),\n",
                "\n",
                "    # users/me -> zerver.views\n",
                "    url(r'^users/me$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.users.get_profile_backend',\n",
                "         'DELETE': 'zerver.views.users.deactivate_user_own_backend'}),\n",
                "    # PUT is currently used by mobile apps, we intend to remove the PUT version\n",
                "    # as soon as possible. POST exists to correct the erroneous use of PUT.\n",
                "    url(r'^users/me/pointer$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.pointer.get_pointer_backend',\n",
                "         'PUT': 'zerver.views.pointer.update_pointer_backend',\n",
                "         'POST': 'zerver.views.pointer.update_pointer_backend'}),\n",
                "    url(r'^users/me/presence$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.presence.update_active_status_backend'}),\n",
                "    # Endpoint used by mobile devices to register their push\n",
                "    # notification credentials\n",
                "    url(r'^users/me/apns_device_token$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.push_notifications.add_apns_device_token',\n",
                "         'DELETE': 'zerver.views.push_notifications.remove_apns_device_token'}),\n",
                "    url(r'^users/me/android_gcm_reg_id$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.push_notifications.add_android_reg_id',\n",
                "         'DELETE': 'zerver.views.push_notifications.remove_android_reg_id'}),\n",
                "\n",
                "    # users/me -> zerver.views.user_settings\n",
                "    url(r'^users/me/api_key/regenerate$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.user_settings.regenerate_api_key'}),\n",
                "    url(r'^users/me/enter-sends$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.user_settings.change_enter_sends'}),\n",
                "    url(r'^users/me/avatar$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.user_settings.set_avatar_backend',\n",
                "         'DELETE': 'zerver.views.user_settings.delete_avatar_backend'}),\n",
                "\n",
                "    # users/me/hotspots -> zerver.views.hotspots\n",
                "    url(r'^users/me/hotspots$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.hotspots.mark_hotspot_as_read'}),\n",
                "\n",
                "    # settings -> zerver.views.user_settings\n",
                "    url(r'^settings/display$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.user_settings.update_display_settings_backend'}),\n",
                "    url(r'^settings/notifications$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.user_settings.json_change_notify_settings'}),\n",
                "    url(r'^settings/ui$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.user_settings.json_change_ui_settings'}),\n",
                "\n",
                "    # users/me/alert_words -> zerver.views.alert_words\n",
                "    url(r'^users/me/alert_words$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.alert_words.list_alert_words',\n",
                "         'POST': 'zerver.views.alert_words.set_alert_words',\n",
                "         'PUT': 'zerver.views.alert_words.add_alert_words',\n",
                "         'DELETE': 'zerver.views.alert_words.remove_alert_words'}),\n",
                "\n",
                "    # users/me/custom_profile_data -> zerver.views.custom_profile_data\n",
                "    url(r'^users/me/profile_data$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.custom_profile_fields.update_user_custom_profile_data'}),\n",
                "\n",
                "    url(r'^users/me/(?P<stream_id>\\d+)/topics$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.streams.get_topics_backend'}),\n",
                "\n",
                "\n",
                "    # streams -> zerver.views.streams\n",
                "    # (this API is only used externally)\n",
                "    url(r'^streams$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.streams.get_streams_backend'}),\n",
                "\n",
                "    # GET returns `stream_id`, stream name should be encoded in the url query (in `stream` param)\n",
                "    url(r'^get_stream_id', rest_dispatch,\n",
                "        {'GET': 'zerver.views.streams.json_get_stream_id'}),\n",
                "\n",
                "    # GET returns \"stream info\" (undefined currently?), HEAD returns whether stream exists (200 or 404)\n",
                "    url(r'^streams/(?P<stream_id>\\d+)/members$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.streams.get_subscribers_backend'}),\n",
                "    url(r'^streams/(?P<stream_id>\\d+)$', rest_dispatch,\n",
                "        {'PATCH': 'zerver.views.streams.update_stream_backend',\n",
                "         'DELETE': 'zerver.views.streams.deactivate_stream_backend'}),\n",
                "    url(r'^default_streams$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.streams.add_default_stream',\n",
                "         'DELETE': 'zerver.views.streams.remove_default_stream'}),\n",
                "    # GET lists your streams, POST bulk adds, PATCH bulk modifies/removes\n",
                "    url(r'^users/me/subscriptions$', rest_dispatch,\n",
                "        {'GET': 'zerver.views.streams.list_subscriptions_backend',\n",
                "         'POST': 'zerver.views.streams.add_subscriptions_backend',\n",
                "         'PATCH': 'zerver.views.streams.update_subscriptions_backend',\n",
                "         'DELETE': 'zerver.views.streams.remove_subscriptions_backend'}),\n",
                "    # muting -> zerver.views.muting\n",
                "    url(r'^users/me/subscriptions/muted_topics$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.muting.set_muted_topics',\n",
                "         'PATCH': 'zerver.views.muting.update_muted_topic'}),\n",
                "\n",
                "    # used to register for an event queue in tornado\n",
                "    url(r'^register$', rest_dispatch,\n",
                "        {'POST': 'zerver.views.events_register.events_register_backend'}),\n",
                "\n",
                "    # events -> zerver.tornado.views\n",
                "    url(r'^events$', rest_dispatch,\n",
                "        {'GET': 'zerver.tornado.views.get_events_backend',\n",
                "         'DELETE': 'zerver.tornado.views.cleanup_event_queue'}),\n",
                "]\n",
                "\n",
                "# Include the dual-use patterns twice\n",
                "urls += [\n",
                "    url(r'^api/v1/', include(v1_api_and_json_patterns)),\n",
                "    url(r'^json/', include(v1_api_and_json_patterns)),\n",
                "]\n",
                "\n",
                "# user_uploads -> zerver.views.upload.serve_file_backend\n",
                "#\n",
                "# This url is an exception to the url naming schemes for endpoints. It\n",
                "# supports both API and session cookie authentication, using a single\n",
                "# URL for both (not 'api/v1/' or 'json/' prefix). This is required to\n",
                "# easily support the mobile apps fetching uploaded files without\n",
                "# having to rewrite URLs, and is implemented using the\n",
                "# 'override_api_url_scheme' flag passed to rest_dispatch\n",
                "urls += url(r'^user_uploads/(?P<realm_id_str>(\\d*|unk))/(?P<filename>.*)',\n",
                "            rest_dispatch,\n",
                "            {'GET': ('zerver.views.upload.serve_file_backend',\n",
                "                     {'override_api_url_scheme'})}),\n",
                "\n",
                "# Incoming webhook URLs\n",
                "# We don't create urls for particular git integrations here\n",
                "# because of generic one below\n",
                "for incoming_webhook in WEBHOOK_INTEGRATIONS:\n",
                "    if incoming_webhook.url_object:\n",
                "        urls.append(incoming_webhook.url_object)\n",
                "\n",
                "urls.append(url(r'^api/v1/external/github', github_dispatcher.api_github_webhook_dispatch))\n",
                "\n",
                "# Mobile-specific authentication URLs\n",
                "urls += [\n",
                "    # This json format view used by the mobile apps lists which\n",
                "    # authentication backends the server allows as well as details\n",
                "    # like the requested subdomains'd realm icon (if known).\n",
                "    url(r'^api/v1/server_settings', zerver.views.auth.api_get_server_settings),\n",
                "    # This is a deprecated old version of api/v1/server_settings that only returns auth backends.\n",
                "    url(r'^api/v1/get_auth_backends', zerver.views.auth.api_get_auth_backends, name='zerver.views.auth.api_get_auth_backends'),\n",
                "\n",
                "    # used by mobile apps to check if they are compatible with the server\n",
                "    url(r'^compatibility$', zerver.views.compatibility.check_compatibility),\n",
                "\n",
                "    # This json format view used by the mobile apps accepts a username\n",
                "    # password/pair and returns an API key.\n",
                "    url(r'^api/v1/fetch_api_key$', zerver.views.auth.api_fetch_api_key, name='zerver.views.auth.api_fetch_api_key'),\n",
                "\n",
                "    # This is for the signing in through the devAuthBackEnd on mobile apps.\n",
                "    url(r'^api/v1/dev_fetch_api_key$', zerver.views.auth.api_dev_fetch_api_key, name='zerver.views.auth.api_dev_fetch_api_key'),\n",
                "    # This is for fetching the emails of the admins and the users.\n",
                "    url(r'^api/v1/dev_get_emails$', zerver.views.auth.api_dev_get_emails, name='zerver.views.auth.api_dev_get_emails'),\n",
                "\n",
                "    # Used to present the GOOGLE_CLIENT_ID to mobile apps\n",
                "    url(r'^api/v1/fetch_google_client_id$',\n",
                "        zerver.views.auth.api_fetch_google_client_id,\n",
                "        name='zerver.views.auth.api_fetch_google_client_id'),\n",
                "]\n",
                "\n",
                "# View for uploading messages from email mirror\n",
                "urls += [\n",
                "    url(r'^email_mirror_message$', zerver.views.email_mirror.email_mirror_message,\n",
                "        name='zerver.views.email_mirror.email_mirror_message'),\n",
                "]\n",
                "\n",
                "# Include URL configuration files for site-specified extra installed\n",
                "# Django apps\n",
                "for app_name in settings.EXTRA_INSTALLED_APPS:\n",
                "    app_dir = os.path.join(settings.DEPLOY_ROOT, app_name)\n",
                "    if os.path.exists(os.path.join(app_dir, 'urls.py')):\n",
                "        urls += [url(r'^', include('%s.urls' % (app_name,)))]\n",
                "        i18n_urls += import_string(\"{}.urls.i18n_urlpatterns\".format(app_name))\n",
                "\n",
                "# Tornado views\n",
                "urls += [\n",
                "    # Used internally for communication between Django and Tornado processes\n",
                "    url(r'^notify_tornado$', zerver.tornado.views.notify, name='zerver.tornado.views.notify'),\n",
                "]\n",
                "\n",
                "# Python Social Auth\n",
                "urls += [url(r'^', include('social_django.urls', namespace='social'))]\n",
                "\n",
                "# User documentation site\n",
                "urls += [url(r'^help/(?P<article>.*)$', HelpView.as_view(template_name='zerver/help/main.html'))]\n",
                "\n",
                "if settings.DEVELOPMENT:\n",
                "    urls += dev_urls.urls\n",
                "    i18n_urls += dev_urls.i18n_urls\n",
                "\n",
                "# The sequence is important; if i18n urls don't come first then\n",
                "# reverse url mapping points to i18n urls which causes the frontend\n",
                "# tests to fail\n",
                "urlpatterns = i18n_patterns(*i18n_urls) + urls + legacy_urls"
            ]
        ]
    },
    "edit_order": [
        [
            0,
            1,
            2,
            3,
            4
        ]
    ],
    "partial_orders": [
        {
            "edit_hunk_pair": [
                0,
                1
            ],
            "edit_order": "bi-directional",
            "reason": "Edit 0 renames the variable endpoint to email_type.",
            "scenario of 0 -> 1": "user is renaming the variable, which maybe top-down order, edit 0 first then edit 1",
            "scenario of 1 -> 0": "user is renaming the variable, which maybe bottom-up order, edit 1 first then edit 0"
        },
        {
            "edit_hunk_pair": [
                2,
                3
            ],
            "edit_order": "bi-directional",
            "reason": "Edit 0 and edit 1 renames two variables in the function signature.",
            "scenario of 0 -> 1": "user is renaming the variable, which maybe top-down order, edit 0 first then edit 1",
            "scenario of 1 -> 0": "user is renaming the variable, which maybe bottom-up order, edit 1 first then edit 0"
        },
        {
            "edit_hunk_pair": [
                2,
                4
            ],
            "edit_order": "bi-directional",
            "reason": "Edit 0 and edit 1 renames two variables in the function signature.",
            "scenario of 0 -> 1": "user is renaming the variable, which maybe top-down order, edit 0 first then edit 1",
            "scenario of 1 -> 0": "user is renaming the variable, which maybe bottom-up order, edit 1 first then edit 0"
        },
        {
            "edit_hunk_pair": [
                3,
                4
            ],
            "edit_order": "bi-directional",
            "reason": "Edit 0 and edit 1 renames two variables in the function signature.",
            "scenario of 0 -> 1": "user is renaming the variable, which maybe top-down order, edit 0 first then edit 1",
            "scenario of 1 -> 0": "user is renaming the variable, which maybe bottom-up order, edit 1 first then edit 0"
        }
    ]
}
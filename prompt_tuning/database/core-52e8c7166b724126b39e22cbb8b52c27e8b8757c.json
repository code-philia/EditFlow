{
    "language": "python",
    "commit_url": "https://github.com/home-assistant/core/commit/52e8c7166b724126b39e22cbb8b52c27e8b8757c",
    "commit_message": "Allow template covers to have opening and closing states (#47925)",
    "commit_snapshots": {
        "homeassistant/components/template/cover.py": [
            [
                "\"\"\"Support for covers which integrate with other components.\"\"\"\n",
                "import logging\n",
                "\n",
                "import voluptuous as vol\n",
                "\n",
                "from homeassistant.components.cover import (\n",
                "    ATTR_POSITION,\n",
                "    ATTR_TILT_POSITION,\n",
                "    DEVICE_CLASSES_SCHEMA,\n",
                "    ENTITY_ID_FORMAT,\n",
                "    PLATFORM_SCHEMA,\n",
                "    SUPPORT_CLOSE,\n",
                "    SUPPORT_CLOSE_TILT,\n",
                "    SUPPORT_OPEN,\n",
                "    SUPPORT_OPEN_TILT,\n",
                "    SUPPORT_SET_POSITION,\n",
                "    SUPPORT_SET_TILT_POSITION,\n",
                "    SUPPORT_STOP,\n",
                "    SUPPORT_STOP_TILT,\n",
                "    CoverEntity,\n",
                ")\n",
                "from homeassistant.const import (\n",
                "    CONF_COVERS,\n",
                "    CONF_DEVICE_CLASS,\n",
                "    CONF_ENTITY_ID,\n",
                "    CONF_ENTITY_PICTURE_TEMPLATE,\n",
                "    CONF_FRIENDLY_NAME,\n",
                "    CONF_ICON_TEMPLATE,\n",
                "    CONF_OPTIMISTIC,\n",
                "    CONF_UNIQUE_ID,\n",
                "    CONF_VALUE_TEMPLATE,\n",
                "    STATE_CLOSED,\n",
                "    STATE_CLOSING,\n",
                "    STATE_OPEN,\n",
                "    STATE_OPENING,\n",
                ")\n",
                "from homeassistant.core import callback\n",
                "from homeassistant.exceptions import TemplateError\n",
                "import homeassistant.helpers.config_validation as cv\n",
                "from homeassistant.helpers.entity import async_generate_entity_id\n",
                "from homeassistant.helpers.script import Script\n",
                "\n",
                "from .const import CONF_AVAILABILITY_TEMPLATE\n",
                "from .template_entity import TemplateEntity\n",
                "\n",
                "_LOGGER = logging.getLogger(__name__)\n",
                "_VALID_STATES = [\n",
                "    STATE_OPEN,\n",
                "    STATE_OPENING,\n",
                "    STATE_CLOSED,\n",
                "    STATE_CLOSING,\n",
                "    \"true\",\n",
                "    \"false\",\n",
                "]\n",
                "\n",
                "CONF_POSITION_TEMPLATE = \"position_template\"\n",
                "CONF_TILT_TEMPLATE = \"tilt_template\"\n",
                "OPEN_ACTION = \"open_cover\"\n",
                "CLOSE_ACTION = \"close_cover\"\n",
                "STOP_ACTION = \"stop_cover\"\n",
                "POSITION_ACTION = \"set_cover_position\"\n",
                "TILT_ACTION = \"set_cover_tilt_position\"\n",
                "CONF_TILT_OPTIMISTIC = \"tilt_optimistic\"\n",
                "\n",
                "CONF_VALUE_OR_POSITION_TEMPLATE = \"value_or_position\"\n",
                "CONF_OPEN_OR_CLOSE = \"open_or_close\"\n",
                "\n",
                "TILT_FEATURES = (\n",
                "    SUPPORT_OPEN_TILT\n",
                "    | SUPPORT_CLOSE_TILT\n",
                "    | SUPPORT_STOP_TILT\n",
                "    | SUPPORT_SET_TILT_POSITION\n",
                ")\n",
                "\n",
                "COVER_SCHEMA = vol.All(\n",
                "    cv.deprecated(CONF_ENTITY_ID),\n",
                "    vol.Schema(\n",
                "        {\n",
                "            vol.Inclusive(OPEN_ACTION, CONF_OPEN_OR_CLOSE): cv.SCRIPT_SCHEMA,\n",
                "            vol.Inclusive(CLOSE_ACTION, CONF_OPEN_OR_CLOSE): cv.SCRIPT_SCHEMA,\n",
                "            vol.Optional(STOP_ACTION): cv.SCRIPT_SCHEMA,\n",
                "            vol.Exclusive(\n",
                "                CONF_POSITION_TEMPLATE, CONF_VALUE_OR_POSITION_TEMPLATE\n",
                "            ): cv.template,\n",
                "            vol.Exclusive(\n",
                "                CONF_VALUE_TEMPLATE, CONF_VALUE_OR_POSITION_TEMPLATE\n",
                "            ): cv.template,\n",
                "            vol.Optional(CONF_AVAILABILITY_TEMPLATE): cv.template,\n",
                "            vol.Optional(CONF_POSITION_TEMPLATE): cv.template,\n",
                "            vol.Optional(CONF_TILT_TEMPLATE): cv.template,\n",
                "            vol.Optional(CONF_ICON_TEMPLATE): cv.template,\n",
                "            vol.Optional(CONF_ENTITY_PICTURE_TEMPLATE): cv.template,\n",
                "            vol.Optional(CONF_DEVICE_CLASS): DEVICE_CLASSES_SCHEMA,\n",
                "            vol.Optional(CONF_OPTIMISTIC): cv.boolean,\n",
                "            vol.Optional(CONF_TILT_OPTIMISTIC): cv.boolean,\n",
                "            vol.Optional(POSITION_ACTION): cv.SCRIPT_SCHEMA,\n",
                "            vol.Optional(TILT_ACTION): cv.SCRIPT_SCHEMA,\n",
                "            vol.Optional(CONF_FRIENDLY_NAME): cv.string,\n",
                "            vol.Optional(CONF_ENTITY_ID): cv.entity_ids,\n",
                "            vol.Optional(CONF_UNIQUE_ID): cv.string,\n",
                "        }\n",
                "    ),\n",
                "    cv.has_at_least_one_key(OPEN_ACTION, POSITION_ACTION),\n",
                ")\n",
                "\n",
                "PLATFORM_SCHEMA = PLATFORM_SCHEMA.extend(\n",
                "    {vol.Required(CONF_COVERS): cv.schema_with_slug_keys(COVER_SCHEMA)}\n",
                ")\n",
                "\n",
                "\n",
                "async def _async_create_entities(hass, config):\n",
                "    \"\"\"Create the Template cover.\"\"\"\n",
                "    covers = []\n",
                "\n",
                "    for device, device_config in config[CONF_COVERS].items():\n",
                "        state_template = device_config.get(CONF_VALUE_TEMPLATE)\n",
                "        position_template = device_config.get(CONF_POSITION_TEMPLATE)\n",
                "        tilt_template = device_config.get(CONF_TILT_TEMPLATE)\n",
                "        icon_template = device_config.get(CONF_ICON_TEMPLATE)\n",
                "        availability_template = device_config.get(CONF_AVAILABILITY_TEMPLATE)\n",
                "        entity_picture_template = device_config.get(CONF_ENTITY_PICTURE_TEMPLATE)\n",
                "\n",
                "        friendly_name = device_config.get(CONF_FRIENDLY_NAME, device)\n",
                "        device_class = device_config.get(CONF_DEVICE_CLASS)\n",
                "        open_action = device_config.get(OPEN_ACTION)\n",
                "        close_action = device_config.get(CLOSE_ACTION)\n",
                "        stop_action = device_config.get(STOP_ACTION)\n",
                "        position_action = device_config.get(POSITION_ACTION)\n",
                "        tilt_action = device_config.get(TILT_ACTION)\n",
                "        optimistic = device_config.get(CONF_OPTIMISTIC)\n",
                "        tilt_optimistic = device_config.get(CONF_TILT_OPTIMISTIC)\n",
                "        unique_id = device_config.get(CONF_UNIQUE_ID)\n",
                "\n",
                "        covers.append(\n",
                "            CoverTemplate(\n",
                "                hass,\n",
                "                device,\n",
                "                friendly_name,\n",
                "                device_class,\n",
                "                state_template,\n",
                "                position_template,\n",
                "                tilt_template,\n",
                "                icon_template,\n",
                "                entity_picture_template,\n",
                "                availability_template,\n",
                "                open_action,\n",
                "                close_action,\n",
                "                stop_action,\n",
                "                position_action,\n",
                "                tilt_action,\n",
                "                optimistic,\n",
                "                tilt_optimistic,\n",
                "                unique_id,\n",
                "            )\n",
                "        )\n",
                "\n",
                "    return covers\n",
                "\n",
                "\n",
                "async def async_setup_platform(hass, config, async_add_entities, discovery_info=None):\n",
                "    \"\"\"Set up the Template cover.\"\"\"\n",
                "    async_add_entities(await _async_create_entities(hass, config))\n",
                "\n",
                "\n",
                "class CoverTemplate(TemplateEntity, CoverEntity):\n",
                "    \"\"\"Representation of a Template cover.\"\"\"\n",
                "\n",
                "    def __init__(\n",
                "        self,\n",
                "        hass,\n",
                "        device_id,\n",
                "        friendly_name,\n",
                "        device_class,\n",
                "        state_template,\n",
                "        position_template,\n",
                "        tilt_template,\n",
                "        icon_template,\n",
                "        entity_picture_template,\n",
                "        availability_template,\n",
                "        open_action,\n",
                "        close_action,\n",
                "        stop_action,\n",
                "        position_action,\n",
                "        tilt_action,\n",
                "        optimistic,\n",
                "        tilt_optimistic,\n",
                "        unique_id,\n",
                "    ):\n",
                "        \"\"\"Initialize the Template cover.\"\"\"\n",
                "        super().__init__(\n",
                "            availability_template=availability_template,\n",
                "            icon_template=icon_template,\n",
                "            entity_picture_template=entity_picture_template,\n",
                "        )\n",
                "        self.entity_id = async_generate_entity_id(\n",
                "            ENTITY_ID_FORMAT, device_id, hass=hass\n",
                "        )\n",
                "        self._name = friendly_name\n",
                "        self._template = state_template\n",
                "        self._position_template = position_template\n",
                "        self._tilt_template = tilt_template\n",
                "        self._device_class = device_class\n",
                "        self._open_script = None\n",
                "        domain = __name__.split(\".\")[-2]\n",
                "        if open_action is not None:\n",
                "            self._open_script = Script(hass, open_action, friendly_name, domain)\n",
                "        self._close_script = None\n",
                "        if close_action is not None:\n",
                "            self._close_script = Script(hass, close_action, friendly_name, domain)\n",
                "        self._stop_script = None\n",
                "        if stop_action is not None:\n",
                "            self._stop_script = Script(hass, stop_action, friendly_name, domain)\n",
                "        self._position_script = None\n",
                "        if position_action is not None:\n",
                "            self._position_script = Script(hass, position_action, friendly_name, domain)\n",
                "        self._tilt_script = None\n",
                "        if tilt_action is not None:\n",
                "            self._tilt_script = Script(hass, tilt_action, friendly_name, domain)\n",
                "        self._optimistic = optimistic or (not state_template and not position_template)\n",
                "        self._tilt_optimistic = tilt_optimistic or not tilt_template\n",
                "        self._position = None\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "        self._is_opening = False\n",
                    "        self._is_closing = False\n"
                ],
                "parent_version_range": {
                    "start": 221,
                    "end": 221
                },
                "child_version_range": {
                    "start": 221,
                    "end": 223
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "CoverTemplate",
                        "signature": "class CoverTemplate(TemplateEntity, CoverEntity):",
                        "at_line": 164
                    },
                    {
                        "type": "function",
                        "name": "__init__",
                        "signature": "def __init__(\n        self,\n        hass,\n        device_id,\n        friendly_name,\n        device_class,\n        state_template,\n        position_template,\n        tilt_template,\n        icon_template,\n        entity_picture_template,\n        availability_template,\n        open_action,\n        close_action,\n        stop_action,\n        position_action,\n        tilt_action,\n        optimistic,\n        tilt_optimistic,\n        unique_id,\n    ):",
                        "at_line": 167
                    }
                ],
                "idx": 0,
                "hunk_diff": "File: homeassistant/components/template/cover.py\nCode:\n           class CoverTemplate(TemplateEntity, CoverEntity):\n               ...\n               def __init__(\n        self,\n        hass,\n        device_id,\n        friendly_name,\n        device_class,\n        state_template,\n        position_template,\n        tilt_template,\n        icon_template,\n        entity_picture_template,\n        availability_template,\n        open_action,\n        close_action,\n        stop_action,\n        position_action,\n        tilt_action,\n        optimistic,\n        tilt_optimistic,\n        unique_id,\n    ):\n                   ...\n218 218            self._optimistic = optimistic or (not state_template and not position_template)\n219 219            self._tilt_optimistic = tilt_optimistic or not tilt_template\n220 220            self._position = None\n    221  +         self._is_opening = False\n    222  +         self._is_closing = False\n221 223            self._tilt_value = None\n222 224            self._unique_id = unique_id\n223 225    \n         ...\n",
                "file_path": "homeassistant/components/template/cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "_is_closing",
                    "_is_opening",
                    "self"
                ],
                "prefix": [
                    "        self._optimistic = optimistic or (not state_template and not position_template)\n",
                    "        self._tilt_optimistic = tilt_optimistic or not tilt_template\n",
                    "        self._position = None\n"
                ],
                "suffix": [
                    "        self._tilt_value = None\n",
                    "        self._unique_id = unique_id\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "        self._tilt_value = None\n",
                "        self._unique_id = unique_id\n",
                "\n",
                "    async def async_added_to_hass(self):\n",
                "        \"\"\"Register callbacks.\"\"\"\n",
                "        if self._template:\n",
                "            self.add_template_attribute(\n",
                "                \"_position\", self._template, None, self._update_state\n",
                "            )\n",
                "        if self._position_template:\n",
                "            self.add_template_attribute(\n",
                "                \"_position\",\n",
                "                self._position_template,\n",
                "                None,\n",
                "                self._update_position,\n",
                "                none_on_template_error=True,\n",
                "            )\n",
                "        if self._tilt_template:\n",
                "            self.add_template_attribute(\n",
                "                \"_tilt_value\",\n",
                "                self._tilt_template,\n",
                "                None,\n",
                "                self._update_tilt,\n",
                "                none_on_template_error=True,\n",
                "            )\n",
                "        await super().async_added_to_hass()\n",
                "\n",
                "    @callback\n",
                "    def _update_state(self, result):\n",
                "        super()._update_state(result)\n",
                "        if isinstance(result, TemplateError):\n",
                "            self._position = None\n",
                "            return\n",
                "\n",
                "        state = str(result).lower()\n",
                "\n",
                "        if state in _VALID_STATES:\n",
                "            if state in (\"true\", STATE_OPEN):\n",
                "                self._position = 100\n",
                "            else:\n",
                "                self._position = 0\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "\n",
                    "            self._is_opening = state == STATE_OPENING\n",
                    "            self._is_closing = state == STATE_CLOSING\n"
                ],
                "parent_version_range": {
                    "start": 262,
                    "end": 262
                },
                "child_version_range": {
                    "start": 264,
                    "end": 267
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if state in _VALID_STATES:",
                        "start_line": 257,
                        "end_line": 268
                    },
                    {
                        "type": "if_statement",
                        "statement": "if state in (\"true\", STATE_OPEN):",
                        "start_line": 258,
                        "end_line": 261
                    },
                    {
                        "type": "else_clause",
                        "statement": "else:",
                        "start_line": 260,
                        "end_line": 261
                    }
                ],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "CoverTemplate",
                        "signature": "class CoverTemplate(TemplateEntity, CoverEntity):",
                        "at_line": 164
                    },
                    {
                        "type": "function",
                        "name": "_update_state",
                        "signature": "def _update_state(self, result):",
                        "at_line": 249
                    }
                ],
                "idx": 1,
                "hunk_diff": "File: homeassistant/components/template/cover.py\nCode:\n           class CoverTemplate(TemplateEntity, CoverEntity):\n               ...\n               def _update_state(self, result):\n                   ...\n259 261                    self._position = 100\n260 262                else:\n261 263                    self._position = 0\n    264  + \n    265  +             self._is_opening = state == STATE_OPENING\n    266  +             self._is_closing = state == STATE_CLOSING\n262 267            else:\n263 268                _LOGGER.error(\n264 269                    \"Received invalid cover is_on state: %s. Expected: %s\",\n         ...\n",
                "file_path": "homeassistant/components/template/cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "STATE_CLOSING",
                    "STATE_OPENING",
                    "_is_closing",
                    "_is_opening",
                    "self",
                    "state"
                ],
                "prefix": [
                    "                self._position = 100\n",
                    "            else:\n",
                    "                self._position = 0\n"
                ],
                "suffix": [
                    "        else:\n",
                    "            _LOGGER.error(\n",
                    "                \"Received invalid cover is_on state: %s. Expected: %s\",\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "        else:\n",
                "            _LOGGER.error(\n",
                "                \"Received invalid cover is_on state: %s. Expected: %s\",\n",
                "                state,\n",
                "                \", \".join(_VALID_STATES),\n",
                "            )\n",
                "            self._position = None\n",
                "\n",
                "    @callback\n",
                "    def _update_position(self, result):\n",
                "        try:\n",
                "            state = float(result)\n",
                "        except ValueError as err:\n",
                "            _LOGGER.error(err)\n",
                "            self._position = None\n",
                "            return\n",
                "\n",
                "        if state < 0 or state > 100:\n",
                "            self._position = None\n",
                "            _LOGGER.error(\n",
                "                \"Cover position value must be\" \" between 0 and 100.\" \" Value was: %.2f\",\n",
                "                state,\n",
                "            )\n",
                "        else:\n",
                "            self._position = state\n",
                "\n",
                "    @callback\n",
                "    def _update_tilt(self, result):\n",
                "        try:\n",
                "            state = float(result)\n",
                "        except ValueError as err:\n",
                "            _LOGGER.error(err)\n",
                "            self._tilt_value = None\n",
                "            return\n",
                "\n",
                "        if state < 0 or state > 100:\n",
                "            self._tilt_value = None\n",
                "            _LOGGER.error(\n",
                "                \"Tilt value must be between 0 and 100. Value was: %.2f\",\n",
                "                state,\n",
                "            )\n",
                "        else:\n",
                "            self._tilt_value = state\n",
                "\n",
                "    @property\n",
                "    def name(self):\n",
                "        \"\"\"Return the name of the cover.\"\"\"\n",
                "        return self._name\n",
                "\n",
                "    @property\n",
                "    def unique_id(self):\n",
                "        \"\"\"Return the unique id of this cover.\"\"\"\n",
                "        return self._unique_id\n",
                "\n",
                "    @property\n",
                "    def is_closed(self):\n",
                "        \"\"\"Return if the cover is closed.\"\"\"\n",
                "        return self._position == 0\n",
                "\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    @property\n",
                    "    def is_opening(self):\n",
                    "        \"\"\"Return if the cover is currently opening.\"\"\"\n",
                    "        return self._is_opening\n",
                    "\n",
                    "    @property\n",
                    "    def is_closing(self):\n",
                    "        \"\"\"Return if the cover is currently closing.\"\"\"\n",
                    "        return self._is_closing\n",
                    "\n"
                ],
                "parent_version_range": {
                    "start": 321,
                    "end": 321
                },
                "child_version_range": {
                    "start": 326,
                    "end": 336
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "CoverTemplate",
                        "signature": "class CoverTemplate(TemplateEntity, CoverEntity):",
                        "at_line": 164
                    }
                ],
                "idx": 2,
                "hunk_diff": "File: homeassistant/components/template/cover.py\nCode:\n           class CoverTemplate(TemplateEntity, CoverEntity):\n               ...\n318 323            \"\"\"Return if the cover is closed.\"\"\"\n319 324            return self._position == 0\n320 325    \n    326  +     @property\n    327  +     def is_opening(self):\n    328  +         \"\"\"Return if the cover is currently opening.\"\"\"\n    329  +         return self._is_opening\n    330  + \n    331  +     @property\n    332  +     def is_closing(self):\n    333  +         \"\"\"Return if the cover is currently closing.\"\"\"\n    334  +         return self._is_closing\n    335  + \n321 336        @property\n322 337        def current_cover_position(self):\n323 338            \"\"\"Return current position of cover.\n         ...\n",
                "file_path": "homeassistant/components/template/cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "_is_closing",
                    "_is_opening",
                    "is_closing",
                    "is_opening",
                    "property",
                    "self"
                ],
                "prefix": [
                    "        \"\"\"Return if the cover is closed.\"\"\"\n",
                    "        return self._position == 0\n",
                    "\n"
                ],
                "suffix": [
                    "    @property\n",
                    "    def current_cover_position(self):\n",
                    "        \"\"\"Return current position of cover.\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "    @property\n",
                "    def current_cover_position(self):\n",
                "        \"\"\"Return current position of cover.\n",
                "\n",
                "        None is unknown, 0 is closed, 100 is fully open.\n",
                "        \"\"\"\n",
                "        if self._position_template or self._position_script:\n",
                "            return self._position\n",
                "        return None\n",
                "\n",
                "    @property\n",
                "    def current_cover_tilt_position(self):\n",
                "        \"\"\"Return current position of cover tilt.\n",
                "\n",
                "        None is unknown, 0 is closed, 100 is fully open.\n",
                "        \"\"\"\n",
                "        return self._tilt_value\n",
                "\n",
                "    @property\n",
                "    def device_class(self):\n",
                "        \"\"\"Return the device class of the cover.\"\"\"\n",
                "        return self._device_class\n",
                "\n",
                "    @property\n",
                "    def supported_features(self):\n",
                "        \"\"\"Flag supported features.\"\"\"\n",
                "        supported_features = SUPPORT_OPEN | SUPPORT_CLOSE\n",
                "\n",
                "        if self._stop_script is not None:\n",
                "            supported_features |= SUPPORT_STOP\n",
                "\n",
                "        if self._position_script is not None:\n",
                "            supported_features |= SUPPORT_SET_POSITION\n",
                "\n",
                "        if self._tilt_script is not None:\n",
                "            supported_features |= TILT_FEATURES\n",
                "\n",
                "        return supported_features\n",
                "\n",
                "    async def async_open_cover(self, **kwargs):\n",
                "        \"\"\"Move the cover up.\"\"\"\n",
                "        if self._open_script:\n",
                "            await self._open_script.async_run(context=self._context)\n",
                "        elif self._position_script:\n",
                "            await self._position_script.async_run(\n",
                "                {\"position\": 100}, context=self._context\n",
                "            )\n",
                "        if self._optimistic:\n",
                "            self._position = 100\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_close_cover(self, **kwargs):\n",
                "        \"\"\"Move the cover down.\"\"\"\n",
                "        if self._close_script:\n",
                "            await self._close_script.async_run(context=self._context)\n",
                "        elif self._position_script:\n",
                "            await self._position_script.async_run(\n",
                "                {\"position\": 0}, context=self._context\n",
                "            )\n",
                "        if self._optimistic:\n",
                "            self._position = 0\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_stop_cover(self, **kwargs):\n",
                "        \"\"\"Fire the stop action.\"\"\"\n",
                "        if self._stop_script:\n",
                "            await self._stop_script.async_run(context=self._context)\n",
                "\n",
                "    async def async_set_cover_position(self, **kwargs):\n",
                "        \"\"\"Set cover position.\"\"\"\n",
                "        self._position = kwargs[ATTR_POSITION]\n",
                "        await self._position_script.async_run(\n",
                "            {\"position\": self._position}, context=self._context\n",
                "        )\n",
                "        if self._optimistic:\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_open_cover_tilt(self, **kwargs):\n",
                "        \"\"\"Tilt the cover open.\"\"\"\n",
                "        self._tilt_value = 100\n",
                "        await self._tilt_script.async_run(\n",
                "            {\"tilt\": self._tilt_value}, context=self._context\n",
                "        )\n",
                "        if self._tilt_optimistic:\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_close_cover_tilt(self, **kwargs):\n",
                "        \"\"\"Tilt the cover closed.\"\"\"\n",
                "        self._tilt_value = 0\n",
                "        await self._tilt_script.async_run(\n",
                "            {\"tilt\": self._tilt_value}, context=self._context\n",
                "        )\n",
                "        if self._tilt_optimistic:\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_cover_tilt_position(self, **kwargs):\n",
                "        \"\"\"Move the cover tilt to a specific position.\"\"\"\n",
                "        self._tilt_value = kwargs[ATTR_TILT_POSITION]\n",
                "        await self._tilt_script.async_run(\n",
                "            {\"tilt\": self._tilt_value}, context=self._context\n",
                "        )\n",
                "        if self._tilt_optimistic:\n",
                "            self.async_write_ha_state()"
            ]
        ],
        "tests/components/template/test_cover.py": [
            {
                "type": "replace",
                "before": [
                    "\"\"\"The tests the cover command line platform.\"\"\"\n"
                ],
                "after": [
                    "\"\"\"The tests for the Template cover platform.\"\"\"\n"
                ],
                "parent_version_range": {
                    "start": 0,
                    "end": 1
                },
                "child_version_range": {
                    "start": 0,
                    "end": 1
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 3,
                "hunk_diff": "File: tests/components/template/test_cover.py\nCode:\n  ...\n0    - \"\"\"The tests the cover command line platform.\"\"\"\n  0  + \"\"\"The tests for the Template cover platform.\"\"\"\n1 1    import pytest\n2 2    \n3 3    from homeassistant import setup\n     ...\n",
                "file_path": "tests/components/template/test_cover.py",
                "identifiers_before": [],
                "identifiers_after": [],
                "prefix": [],
                "suffix": [
                    "import pytest\n",
                    "\n",
                    "from homeassistant import setup\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "import pytest\n",
                "\n",
                "from homeassistant import setup\n",
                "from homeassistant.components.cover import ATTR_POSITION, ATTR_TILT_POSITION, DOMAIN\n",
                "from homeassistant.const import (\n",
                "    ATTR_ENTITY_ID,\n",
                "    SERVICE_CLOSE_COVER,\n",
                "    SERVICE_CLOSE_COVER_TILT,\n",
                "    SERVICE_OPEN_COVER,\n",
                "    SERVICE_OPEN_COVER_TILT,\n",
                "    SERVICE_SET_COVER_POSITION,\n",
                "    SERVICE_SET_COVER_TILT_POSITION,\n",
                "    SERVICE_STOP_COVER,\n",
                "    SERVICE_TOGGLE,\n",
                "    SERVICE_TOGGLE_COVER_TILT,\n",
                "    STATE_CLOSED,\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    STATE_CLOSING,\n"
                ],
                "parent_version_range": {
                    "start": 17,
                    "end": 17
                },
                "child_version_range": {
                    "start": 17,
                    "end": 18
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 4,
                "hunk_diff": "File: tests/components/template/test_cover.py\nCode:\n  ...\n14 14        SERVICE_TOGGLE,\n15 15        SERVICE_TOGGLE_COVER_TILT,\n16 16        STATE_CLOSED,\n   17  +     STATE_CLOSING,\n17 18        STATE_OFF,\n18 19        STATE_ON,\n19 20        STATE_OPEN,\n       ...\n",
                "file_path": "tests/components/template/test_cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "STATE_CLOSING"
                ],
                "prefix": [
                    "    SERVICE_TOGGLE,\n",
                    "    SERVICE_TOGGLE_COVER_TILT,\n",
                    "    STATE_CLOSED,\n"
                ],
                "suffix": [
                    "    STATE_OFF,\n",
                    "    STATE_ON,\n",
                    "    STATE_OPEN,\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "STATE_CLOSING",
                            "position": {
                                "start": {
                                    "line": 17,
                                    "column": 4
                                },
                                "end": {
                                    "line": 17,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 4,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "STATE_CLOSING",
                            "position": {
                                "start": {
                                    "line": 17,
                                    "column": 4
                                },
                                "end": {
                                    "line": 17,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 4,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "    STATE_OFF,\n",
                "    STATE_ON,\n",
                "    STATE_OPEN,\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    STATE_OPENING,\n"
                ],
                "parent_version_range": {
                    "start": 20,
                    "end": 20
                },
                "child_version_range": {
                    "start": 21,
                    "end": 22
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 5,
                "hunk_diff": "File: tests/components/template/test_cover.py\nCode:\n  ...\n17 18        STATE_OFF,\n18 19        STATE_ON,\n19 20        STATE_OPEN,\n   21  +     STATE_OPENING,\n20 22        STATE_UNAVAILABLE,\n21 23    )\n22 24    \n       ...\n",
                "file_path": "tests/components/template/test_cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "STATE_OPENING"
                ],
                "prefix": [
                    "    STATE_OFF,\n",
                    "    STATE_ON,\n",
                    "    STATE_OPEN,\n"
                ],
                "suffix": [
                    "    STATE_UNAVAILABLE,\n",
                    ")\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "STATE_OPENING",
                            "position": {
                                "start": {
                                    "line": 21,
                                    "column": 4
                                },
                                "end": {
                                    "line": 21,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 5,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "STATE_OPENING",
                            "position": {
                                "start": {
                                    "line": 21,
                                    "column": 4
                                },
                                "end": {
                                    "line": 21,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 5,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "    STATE_UNAVAILABLE,\n",
                ")\n",
                "\n",
                "from tests.common import assert_setup_component, async_mock_service\n",
                "\n",
                "ENTITY_COVER = \"cover.test_template_cover\"\n",
                "\n",
                "\n",
                "@pytest.fixture(name=\"calls\")\n",
                "def calls_fixture(hass):\n",
                "    \"\"\"Track calls to a mock service.\"\"\"\n",
                "    return async_mock_service(hass, \"test\", \"automation\")\n",
                "\n",
                "\n",
                "async def test_template_state_text(hass, calls):\n",
                "    \"\"\"Test the state text of a template.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ states.cover.test_state.state }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test_state\", STATE_OPEN)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test_state\", STATE_CLOSED)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_CLOSED\n",
                "\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    state = hass.states.async_set(\"cover.test_state\", STATE_OPENING)\n",
                    "    await hass.async_block_till_done()\n",
                    "\n",
                    "    state = hass.states.get(\"cover.test_template_cover\")\n",
                    "    assert state.state == STATE_OPENING\n",
                    "\n",
                    "    state = hass.states.async_set(\"cover.test_state\", STATE_CLOSING)\n",
                    "    await hass.async_block_till_done()\n",
                    "\n",
                    "    state = hass.states.get(\"cover.test_template_cover\")\n",
                    "    assert state.state == STATE_CLOSING\n",
                    "\n"
                ],
                "parent_version_range": {
                    "start": 76,
                    "end": 76
                },
                "child_version_range": {
                    "start": 78,
                    "end": 90
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 6,
                "hunk_diff": "File: tests/components/template/test_cover.py\nCode:\n  ...\n73 75        state = hass.states.get(\"cover.test_template_cover\")\n74 76        assert state.state == STATE_CLOSED\n75 77    \n   78  +     state = hass.states.async_set(\"cover.test_state\", STATE_OPENING)\n   79  +     await hass.async_block_till_done()\n   80  + \n   81  +     state = hass.states.get(\"cover.test_template_cover\")\n   82  +     assert state.state == STATE_OPENING\n   83  + \n   84  +     state = hass.states.async_set(\"cover.test_state\", STATE_CLOSING)\n   85  +     await hass.async_block_till_done()\n   86  + \n   87  +     state = hass.states.get(\"cover.test_template_cover\")\n   88  +     assert state.state == STATE_CLOSING\n   89  + \n76 90    \n77 91    async def test_template_state_boolean(hass, calls):\n78 92        \"\"\"Test the value_template attribute.\"\"\"\n       ...\n",
                "file_path": "tests/components/template/test_cover.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "STATE_CLOSING",
                    "STATE_OPENING",
                    "async_block_till_done",
                    "async_set",
                    "get",
                    "hass",
                    "state",
                    "states"
                ],
                "prefix": [
                    "    state = hass.states.get(\"cover.test_template_cover\")\n",
                    "    assert state.state == STATE_CLOSED\n",
                    "\n"
                ],
                "suffix": [
                    "\n",
                    "async def test_template_state_boolean(hass, calls):\n",
                    "    \"\"\"Test the value_template attribute.\"\"\"\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 4,
                        "detail": {
                            "identifier": "STATE_CLOSING",
                            "position": {
                                "start": {
                                    "line": 84,
                                    "column": 54
                                },
                                "end": {
                                    "line": 84,
                                    "column": 67
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 4,
                        "detail": {
                            "identifier": "STATE_CLOSING",
                            "position": {
                                "start": {
                                    "line": 88,
                                    "column": 26
                                },
                                "end": {
                                    "line": 88,
                                    "column": 39
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 5,
                        "detail": {
                            "identifier": "STATE_OPENING",
                            "position": {
                                "start": {
                                    "line": 78,
                                    "column": 54
                                },
                                "end": {
                                    "line": 78,
                                    "column": 67
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 5,
                        "detail": {
                            "identifier": "STATE_OPENING",
                            "position": {
                                "start": {
                                    "line": 82,
                                    "column": 26
                                },
                                "end": {
                                    "line": 82,
                                    "column": 39
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/tests/components/template/test_cover.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "\n",
                "async def test_template_state_boolean(hass, calls):\n",
                "    \"\"\"Test the value_template attribute.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ 1 == 1 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "\n",
                "async def test_template_position(hass, calls):\n",
                "    \"\"\"Test the position_template attribute.\"\"\"\n",
                "    hass.states.async_set(\"cover.test\", STATE_OPEN)\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ states.cover.test.attributes.position }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test\", STATE_CLOSED)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    entity = hass.states.get(\"cover.test\")\n",
                "    attrs = {}\n",
                "    attrs[\"position\"] = 42\n",
                "    hass.states.async_set(entity.entity_id, entity.state, attributes=attrs)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 42.0\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test\", STATE_OPEN)\n",
                "    await hass.async_block_till_done()\n",
                "    entity = hass.states.get(\"cover.test\")\n",
                "    attrs[\"position\"] = 0.0\n",
                "    hass.states.async_set(entity.entity_id, entity.state, attributes=attrs)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 0.0\n",
                "    assert state.state == STATE_CLOSED\n",
                "\n",
                "\n",
                "async def test_template_tilt(hass, calls):\n",
                "    \"\"\"Test the tilt_template attribute.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ 1 == 1 }}\",\n",
                "                            \"tilt_template\": \"{{ 42 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 42.0\n",
                "\n",
                "\n",
                "async def test_template_out_of_bounds(hass, calls):\n",
                "    \"\"\"Test template out-of-bounds condition.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ -1 }}\",\n",
                "                            \"tilt_template\": \"{{ 110 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") is None\n",
                "    assert state.attributes.get(\"current_position\") is None\n",
                "\n",
                "\n",
                "async def test_template_mutex(hass, calls):\n",
                "    \"\"\"Test that only value or position template can be used.\"\"\"\n",
                "    with assert_setup_component(0, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ 1 == 1 }}\",\n",
                "                            \"position_template\": \"{{ 42 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"icon_template\": \"{% if states.cover.test_state.state %}\"\n",
                "                            \"mdi:check\"\n",
                "                            \"{% endif %}\",\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.async_all() == []\n",
                "\n",
                "\n",
                "async def test_template_open_or_position(hass, caplog):\n",
                "    \"\"\"Test that at least one of open_cover or set_position is used.\"\"\"\n",
                "    assert await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\"test_template_cover\": {\"value_template\": \"{{ 1 == 1 }}\"}},\n",
                "            }\n",
                "        },\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.async_all() == []\n",
                "    assert \"Invalid config for [cover.template]\" in caplog.text\n",
                "\n",
                "\n",
                "async def test_template_open_and_close(hass, calls):\n",
                "    \"\"\"Test that if open_cover is specified, close_cover is too.\"\"\"\n",
                "    with assert_setup_component(0, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ 1 == 1 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.async_all() == []\n",
                "\n",
                "\n",
                "async def test_template_non_numeric(hass, calls):\n",
                "    \"\"\"Test that tilt_template values are numeric.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ on }}\",\n",
                "                            \"tilt_template\": \"{% if states.cover.test_state.state %}\"\n",
                "                            \"on\"\n",
                "                            \"{% else %}\"\n",
                "                            \"off\"\n",
                "                            \"{% endif %}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") is None\n",
                "    assert state.attributes.get(\"current_position\") is None\n",
                "\n",
                "\n",
                "async def test_open_action(hass, calls):\n",
                "    \"\"\"Test the open_cover command.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 0 }}\",\n",
                "                            \"open_cover\": {\"service\": \"test.automation\"},\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_CLOSED\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_OPEN_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(calls) == 1\n",
                "\n",
                "\n",
                "async def test_close_stop_action(hass, calls):\n",
                "    \"\"\"Test the close-cover and stop_cover commands.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 100 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\"service\": \"test.automation\"},\n",
                "                            \"stop_cover\": {\"service\": \"test.automation\"},\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_CLOSE_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_STOP_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(calls) == 2\n",
                "\n",
                "\n",
                "async def test_set_position(hass, calls):\n",
                "    \"\"\"Test the set_position command.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"input_number\",\n",
                "            {\"input_number\": {\"test\": {\"min\": \"0\", \"max\": \"100\", \"initial\": \"42\"}}},\n",
                "        )\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ states.input_number.test.state | int }}\",\n",
                "                            \"set_cover_position\": {\n",
                "                                \"service\": \"input_number.set_value\",\n",
                "                                \"entity_id\": \"input_number.test\",\n",
                "                                \"data_template\": {\"value\": \"{{ position }}\"},\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.async_set(\"input_number.test\", 42)\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_OPEN_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 100.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_CLOSE_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 0.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 100.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 0.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN,\n",
                "        SERVICE_SET_COVER_POSITION,\n",
                "        {ATTR_ENTITY_ID: ENTITY_COVER, ATTR_POSITION: 25},\n",
                "        blocking=True,\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 25.0\n",
                "\n",
                "\n",
                "async def test_set_tilt_position(hass, calls):\n",
                "    \"\"\"Test the set_tilt_position command.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 100 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"set_cover_tilt_position\": {\"service\": \"test.automation\"},\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN,\n",
                "        SERVICE_SET_COVER_TILT_POSITION,\n",
                "        {ATTR_ENTITY_ID: ENTITY_COVER, ATTR_TILT_POSITION: 42},\n",
                "        blocking=True,\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(calls) == 1\n",
                "\n",
                "\n",
                "async def test_open_tilt_action(hass, calls):\n",
                "    \"\"\"Test the open_cover_tilt command.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 100 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"set_cover_tilt_position\": {\"service\": \"test.automation\"},\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_OPEN_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(calls) == 1\n",
                "\n",
                "\n",
                "async def test_close_tilt_action(hass, calls):\n",
                "    \"\"\"Test the close_cover_tilt command.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 100 }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"set_cover_tilt_position\": {\"service\": \"test.automation\"},\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_CLOSE_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(calls) == 1\n",
                "\n",
                "\n",
                "async def test_set_position_optimistic(hass, calls):\n",
                "    \"\"\"Test optimistic position mode.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"set_cover_position\": {\"service\": \"test.automation\"}\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") is None\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN,\n",
                "        SERVICE_SET_COVER_POSITION,\n",
                "        {ATTR_ENTITY_ID: ENTITY_COVER, ATTR_POSITION: 42},\n",
                "        blocking=True,\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_position\") == 42.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_CLOSE_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_CLOSED\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_OPEN_COVER, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_CLOSED\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state == STATE_OPEN\n",
                "\n",
                "\n",
                "async def test_set_tilt_position_optimistic(hass, calls):\n",
                "    \"\"\"Test the optimistic tilt_position mode.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"position_template\": \"{{ 100 }}\",\n",
                "                            \"set_cover_position\": {\"service\": \"test.automation\"},\n",
                "                            \"set_cover_tilt_position\": {\"service\": \"test.automation\"},\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") is None\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN,\n",
                "        SERVICE_SET_COVER_TILT_POSITION,\n",
                "        {ATTR_ENTITY_ID: ENTITY_COVER, ATTR_TILT_POSITION: 42},\n",
                "        blocking=True,\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 42.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_CLOSE_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 0.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_OPEN_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 100.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 0.0\n",
                "\n",
                "    await hass.services.async_call(\n",
                "        DOMAIN, SERVICE_TOGGLE_COVER_TILT, {ATTR_ENTITY_ID: ENTITY_COVER}, blocking=True\n",
                "    )\n",
                "    await hass.async_block_till_done()\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"current_tilt_position\") == 100.0\n",
                "\n",
                "\n",
                "async def test_icon_template(hass, calls):\n",
                "    \"\"\"Test icon template.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ states.cover.test_state.state }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"icon_template\": \"{% if states.cover.test_state.state %}\"\n",
                "                            \"mdi:check\"\n",
                "                            \"{% endif %}\",\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"icon\") == \"\"\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test_state\", STATE_OPEN)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "\n",
                "    assert state.attributes[\"icon\"] == \"mdi:check\"\n",
                "\n",
                "\n",
                "async def test_entity_picture_template(hass, calls):\n",
                "    \"\"\"Test icon template.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ states.cover.test_state.state }}\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"entity_picture_template\": \"{% if states.cover.test_state.state %}\"\n",
                "                            \"/local/cover.png\"\n",
                "                            \"{% endif %}\",\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"entity_picture\") == \"\"\n",
                "\n",
                "    state = hass.states.async_set(\"cover.test_state\", STATE_OPEN)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "\n",
                "    assert state.attributes[\"entity_picture\"] == \"/local/cover.png\"\n",
                "\n",
                "\n",
                "async def test_availability_template(hass, calls):\n",
                "    \"\"\"Test availability template.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"open\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"availability_template\": \"{{ is_state('availability_state.state','on') }}\",\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    hass.states.async_set(\"availability_state.state\", STATE_OFF)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.get(\"cover.test_template_cover\").state == STATE_UNAVAILABLE\n",
                "\n",
                "    hass.states.async_set(\"availability_state.state\", STATE_ON)\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.get(\"cover.test_template_cover\").state != STATE_UNAVAILABLE\n",
                "\n",
                "\n",
                "async def test_availability_without_availability_template(hass, calls):\n",
                "    \"\"\"Test that component is available if there is no.\"\"\"\n",
                "    assert await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\n",
                "                    \"test_template_cover\": {\n",
                "                        \"value_template\": \"open\",\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"cover.open_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"cover.close_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                    }\n",
                "                },\n",
                "            }\n",
                "        },\n",
                "    )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.state != STATE_UNAVAILABLE\n",
                "\n",
                "\n",
                "async def test_invalid_availability_template_keeps_component_available(hass, caplog):\n",
                "    \"\"\"Test that an invalid availability keeps the device available.\"\"\"\n",
                "    assert await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\n",
                "                    \"test_template_cover\": {\n",
                "                        \"availability_template\": \"{{ x - 12 }}\",\n",
                "                        \"value_template\": \"open\",\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"cover.open_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"cover.close_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                    }\n",
                "                },\n",
                "            }\n",
                "        },\n",
                "    )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert hass.states.get(\"cover.test_template_cover\") != STATE_UNAVAILABLE\n",
                "    assert (\"UndefinedError: 'x' is undefined\") in caplog.text\n",
                "\n",
                "\n",
                "async def test_device_class(hass, calls):\n",
                "    \"\"\"Test device class.\"\"\"\n",
                "    with assert_setup_component(1, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ states.cover.test_state.state }}\",\n",
                "                            \"device_class\": \"door\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert state.attributes.get(\"device_class\") == \"door\"\n",
                "\n",
                "\n",
                "async def test_invalid_device_class(hass, calls):\n",
                "    \"\"\"Test device class.\"\"\"\n",
                "    with assert_setup_component(0, \"cover\"):\n",
                "        assert await setup.async_setup_component(\n",
                "            hass,\n",
                "            \"cover\",\n",
                "            {\n",
                "                \"cover\": {\n",
                "                    \"platform\": \"template\",\n",
                "                    \"covers\": {\n",
                "                        \"test_template_cover\": {\n",
                "                            \"value_template\": \"{{ states.cover.test_state.state }}\",\n",
                "                            \"device_class\": \"barnacle_bill\",\n",
                "                            \"open_cover\": {\n",
                "                                \"service\": \"cover.open_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                            \"close_cover\": {\n",
                "                                \"service\": \"cover.close_cover\",\n",
                "                                \"entity_id\": \"cover.test_state\",\n",
                "                            },\n",
                "                        }\n",
                "                    },\n",
                "                }\n",
                "            },\n",
                "        )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    state = hass.states.get(\"cover.test_template_cover\")\n",
                "    assert not state\n",
                "\n",
                "\n",
                "async def test_unique_id(hass):\n",
                "    \"\"\"Test unique_id option only creates one cover per id.\"\"\"\n",
                "    await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\n",
                "                    \"test_template_cover_01\": {\n",
                "                        \"unique_id\": \"not-so-unique-anymore\",\n",
                "                        \"value_template\": \"{{ true }}\",\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"cover.open_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"cover.close_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                    },\n",
                "                    \"test_template_cover_02\": {\n",
                "                        \"unique_id\": \"not-so-unique-anymore\",\n",
                "                        \"value_template\": \"{{ false }}\",\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"cover.open_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"cover.close_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                    },\n",
                "                },\n",
                "            },\n",
                "        },\n",
                "    )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(hass.states.async_all()) == 1\n",
                "\n",
                "\n",
                "async def test_state_gets_lowercased(hass):\n",
                "    \"\"\"Test True/False is lowercased.\"\"\"\n",
                "\n",
                "    hass.states.async_set(\"binary_sensor.garage_door_sensor\", \"off\")\n",
                "\n",
                "    await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\n",
                "                    \"garage_door\": {\n",
                "                        \"friendly_name\": \"Garage Door\",\n",
                "                        \"value_template\": \"{{ is_state('binary_sensor.garage_door_sensor', 'off') }}\",\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"cover.open_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"cover.close_cover\",\n",
                "                            \"entity_id\": \"cover.test_state\",\n",
                "                        },\n",
                "                    },\n",
                "                },\n",
                "            },\n",
                "        },\n",
                "    )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(hass.states.async_all()) == 2\n",
                "\n",
                "    assert hass.states.get(\"cover.garage_door\").state == STATE_OPEN\n",
                "    hass.states.async_set(\"binary_sensor.garage_door_sensor\", \"on\")\n",
                "    await hass.async_block_till_done()\n",
                "    assert hass.states.get(\"cover.garage_door\").state == STATE_CLOSED\n",
                "\n",
                "\n",
                "async def test_self_referencing_icon_with_no_template_is_not_a_loop(hass, caplog):\n",
                "    \"\"\"Test a self referencing icon with no value template is not a loop.\"\"\"\n",
                "\n",
                "    icon_template_str = \"\"\"{% if is_state('cover.office', 'open') %}\n",
                "            mdi:window-shutter-open\n",
                "          {% else %}\n",
                "            mdi:window-shutter\n",
                "          {% endif %}\"\"\"\n",
                "\n",
                "    await setup.async_setup_component(\n",
                "        hass,\n",
                "        \"cover\",\n",
                "        {\n",
                "            \"cover\": {\n",
                "                \"platform\": \"template\",\n",
                "                \"covers\": {\n",
                "                    \"office\": {\n",
                "                        \"icon_template\": icon_template_str,\n",
                "                        \"open_cover\": {\n",
                "                            \"service\": \"switch.turn_on\",\n",
                "                            \"entity_id\": \"switch.office_blinds_up\",\n",
                "                        },\n",
                "                        \"close_cover\": {\n",
                "                            \"service\": \"switch.turn_on\",\n",
                "                            \"entity_id\": \"switch.office_blinds_down\",\n",
                "                        },\n",
                "                        \"stop_cover\": {\n",
                "                            \"service\": \"switch.turn_on\",\n",
                "                            \"entity_id\": \"switch.office_blinds_up\",\n",
                "                        },\n",
                "                    },\n",
                "                },\n",
                "            }\n",
                "        },\n",
                "    )\n",
                "\n",
                "    await hass.async_block_till_done()\n",
                "    await hass.async_start()\n",
                "    await hass.async_block_till_done()\n",
                "\n",
                "    assert len(hass.states.async_all()) == 1\n",
                "\n",
                "    assert \"Template loop detected\" not in caplog.text"
            ]
        ]
    },
    "partial_orders": [
        {
            "edit_hunk_pair": [
                0,
                1
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                0,
                2
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                4,
                6
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                5,
                6
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        }
    ]
}
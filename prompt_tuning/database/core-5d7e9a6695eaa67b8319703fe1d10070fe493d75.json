{
    "language": "python",
    "commit_url": "https://github.com/home-assistant/core/commit/5d7e9a6695eaa67b8319703fe1d10070fe493d75",
    "commit_message": "Fix setting and reading percentage for MIOT based fans (#77626)",
    "commit_snapshots": {
        "homeassistant/components/xiaomi_miio/const.py": [
            [
                "\"\"\"Constants for the Xiaomi Miio component.\"\"\"\n",
                "from miio.vacuum import (\n",
                "    ROCKROBO_S5,\n",
                "    ROCKROBO_S6,\n",
                "    ROCKROBO_S6_MAXV,\n",
                "    ROCKROBO_S7,\n",
                "    ROCKROBO_V1,\n",
                ")\n",
                "\n",
                "DOMAIN = \"xiaomi_miio\"\n",
                "\n",
                "# Config flow\n",
                "CONF_FLOW_TYPE = \"config_flow_device\"\n",
                "CONF_GATEWAY = \"gateway\"\n",
                "CONF_DEVICE = \"device\"\n",
                "CONF_MAC = \"mac\"\n",
                "CONF_CLOUD_USERNAME = \"cloud_username\"\n",
                "CONF_CLOUD_PASSWORD = \"cloud_password\"\n",
                "CONF_CLOUD_COUNTRY = \"cloud_country\"\n",
                "CONF_MANUAL = \"manual\"\n",
                "\n",
                "# Options flow\n",
                "CONF_CLOUD_SUBDEVICES = \"cloud_subdevices\"\n",
                "\n",
                "# Keys\n",
                "KEY_COORDINATOR = \"coordinator\"\n",
                "KEY_DEVICE = \"device\"\n",
                "\n",
                "# Attributes\n",
                "ATTR_AVAILABLE = \"available\"\n",
                "\n",
                "# Status\n",
                "SUCCESS = [\"ok\"]\n",
                "\n",
                "# Cloud\n",
                "SERVER_COUNTRY_CODES = [\"cn\", \"de\", \"i2\", \"ru\", \"sg\", \"us\"]\n",
                "DEFAULT_CLOUD_COUNTRY = \"cn\"\n",
                "\n",
                "\n",
                "# Exceptions\n",
                "class AuthException(Exception):\n",
                "    \"\"\"Exception indicating an authentication error.\"\"\"\n",
                "\n",
                "\n",
                "class SetupException(Exception):\n",
                "    \"\"\"Exception indicating a failure during setup.\"\"\"\n",
                "\n",
                "\n",
                "# Fan Models\n",
                "MODEL_AIRPURIFIER_4 = \"zhimi.airp.mb5\"\n",
                "MODEL_AIRPURIFIER_4_PRO = \"zhimi.airp.vb4\"\n",
                "MODEL_AIRPURIFIER_2H = \"zhimi.airpurifier.mc2\"\n",
                "MODEL_AIRPURIFIER_2S = \"zhimi.airpurifier.mc1\"\n",
                "MODEL_AIRPURIFIER_3 = \"zhimi.airpurifier.ma4\"\n",
                "MODEL_AIRPURIFIER_3C = \"zhimi.airpurifier.mb4\"\n",
                "MODEL_AIRPURIFIER_3H = \"zhimi.airpurifier.mb3\"\n",
                "MODEL_AIRPURIFIER_M1 = \"zhimi.airpurifier.m1\"\n",
                "MODEL_AIRPURIFIER_M2 = \"zhimi.airpurifier.m2\"\n",
                "MODEL_AIRPURIFIER_MA1 = \"zhimi.airpurifier.ma1\"\n",
                "MODEL_AIRPURIFIER_MA2 = \"zhimi.airpurifier.ma2\"\n",
                "MODEL_AIRPURIFIER_PRO = \"zhimi.airpurifier.v6\"\n",
                "MODEL_AIRPURIFIER_PROH = \"zhimi.airpurifier.va1\"\n",
                "MODEL_AIRPURIFIER_PRO_V7 = \"zhimi.airpurifier.v7\"\n",
                "MODEL_AIRPURIFIER_SA1 = \"zhimi.airpurifier.sa1\"\n",
                "MODEL_AIRPURIFIER_SA2 = \"zhimi.airpurifier.sa2\"\n",
                "MODEL_AIRPURIFIER_V1 = \"zhimi.airpurifier.v1\"\n",
                "MODEL_AIRPURIFIER_V2 = \"zhimi.airpurifier.v2\"\n",
                "MODEL_AIRPURIFIER_V3 = \"zhimi.airpurifier.v3\"\n",
                "MODEL_AIRPURIFIER_V5 = \"zhimi.airpurifier.v5\"\n",
                "\n",
                "MODEL_AIRHUMIDIFIER_V1 = \"zhimi.humidifier.v1\"\n",
                "MODEL_AIRHUMIDIFIER_CA1 = \"zhimi.humidifier.ca1\"\n",
                "MODEL_AIRHUMIDIFIER_CA4 = \"zhimi.humidifier.ca4\"\n",
                "MODEL_AIRHUMIDIFIER_CB1 = \"zhimi.humidifier.cb1\"\n",
                "MODEL_AIRHUMIDIFIER_JSQ = \"deerma.humidifier.jsq\"\n",
                "MODEL_AIRHUMIDIFIER_JSQ1 = \"deerma.humidifier.jsq1\"\n",
                "MODEL_AIRHUMIDIFIER_MJJSQ = \"deerma.humidifier.mjjsq\"\n",
                "\n",
                "MODEL_AIRFRESH_A1 = \"dmaker.airfresh.a1\"\n",
                "MODEL_AIRFRESH_VA2 = \"zhimi.airfresh.va2\"\n",
                "MODEL_AIRFRESH_VA4 = \"zhimi.airfresh.va4\"\n",
                "MODEL_AIRFRESH_T2017 = \"dmaker.airfresh.t2017\"\n",
                "\n",
                "MODEL_FAN_1C = \"dmaker.fan.1c\"\n",
                "MODEL_FAN_P10 = \"dmaker.fan.p10\"\n",
                "MODEL_FAN_P11 = \"dmaker.fan.p11\"\n",
                "MODEL_FAN_P5 = \"dmaker.fan.p5\"\n",
                "MODEL_FAN_P9 = \"dmaker.fan.p9\"\n",
                "MODEL_FAN_SA1 = \"zhimi.fan.sa1\"\n",
                "MODEL_FAN_V2 = \"zhimi.fan.v2\"\n",
                "MODEL_FAN_V3 = \"zhimi.fan.v3\"\n",
                "MODEL_FAN_ZA1 = \"zhimi.fan.za1\"\n",
                "MODEL_FAN_ZA3 = \"zhimi.fan.za3\"\n",
                "MODEL_FAN_ZA4 = \"zhimi.fan.za4\"\n",
                "MODEL_FAN_ZA5 = \"zhimi.fan.za5\"\n",
                "\n",
                "MODELS_FAN_MIIO = [\n",
                "    MODEL_FAN_P5,\n",
                "    MODEL_FAN_SA1,\n",
                "    MODEL_FAN_V2,\n",
                "    MODEL_FAN_V3,\n",
                "    MODEL_FAN_ZA1,\n",
                "    MODEL_FAN_ZA3,\n",
                "    MODEL_FAN_ZA4,\n",
                "]\n",
                "\n",
                "MODELS_FAN_MIOT = [\n",
                "    MODEL_FAN_1C,\n",
                "    MODEL_FAN_P10,\n",
                "    MODEL_FAN_P11,\n",
                "    MODEL_FAN_P9,\n",
                "    MODEL_FAN_ZA5,\n",
                "]\n",
                "\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "# number of speed levels each fan has\n",
                    "SPEEDS_FAN_MIOT = {\n",
                    "    MODEL_FAN_1C: 3,\n",
                    "    MODEL_FAN_P10: 4,\n",
                    "    MODEL_FAN_P11: 4,\n",
                    "    MODEL_FAN_P9: 4,\n",
                    "    MODEL_FAN_ZA5: 4,\n",
                    "}\n",
                    "\n"
                ],
                "parent_version_range": {
                    "start": 114,
                    "end": 114
                },
                "child_version_range": {
                    "start": 114,
                    "end": 123
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 0,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/const.py\nCode:\n  ...\n111 111        MODEL_FAN_ZA5,\n112 112    ]\n113 113    \n    114  + # number of speed levels each fan has\n    115  + SPEEDS_FAN_MIOT = {\n    116  +     MODEL_FAN_1C: 3,\n    117  +     MODEL_FAN_P10: 4,\n    118  +     MODEL_FAN_P11: 4,\n    119  +     MODEL_FAN_P9: 4,\n    120  +     MODEL_FAN_ZA5: 4,\n    121  + }\n    122  + \n114 123    MODELS_PURIFIER_MIOT = [\n115 124        MODEL_AIRPURIFIER_3,\n116 125        MODEL_AIRPURIFIER_3C,\n         ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/const.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "MODEL_FAN_1C",
                    "MODEL_FAN_P10",
                    "MODEL_FAN_P11",
                    "MODEL_FAN_P9",
                    "MODEL_FAN_ZA5",
                    "SPEEDS_FAN_MIOT"
                ],
                "prefix": [
                    "    MODEL_FAN_ZA5,\n",
                    "]\n",
                    "\n"
                ],
                "suffix": [
                    "MODELS_PURIFIER_MIOT = [\n",
                    "    MODEL_AIRPURIFIER_3,\n",
                    "    MODEL_AIRPURIFIER_3C,\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 115,
                                    "column": 0
                                },
                                "end": {
                                    "line": 115,
                                    "column": 15
                                }
                            },
                            "type": "identifier",
                            "kind": "variable",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/const.py",
                            "hunk_idx": 0,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 115,
                                    "column": 0
                                },
                                "end": {
                                    "line": 115,
                                    "column": 15
                                }
                            },
                            "type": "identifier",
                            "kind": "variable",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/const.py",
                            "hunk_idx": 0,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 1,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 115,
                                    "column": 0
                                },
                                "end": {
                                    "line": 115,
                                    "column": 15
                                }
                            },
                            "type": "identifier",
                            "kind": "variable",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/const.py",
                            "hunk_idx": 0,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "MODELS_PURIFIER_MIOT = [\n",
                "    MODEL_AIRPURIFIER_3,\n",
                "    MODEL_AIRPURIFIER_3C,\n",
                "    MODEL_AIRPURIFIER_3H,\n",
                "    MODEL_AIRPURIFIER_PROH,\n",
                "    MODEL_AIRPURIFIER_4,\n",
                "    MODEL_AIRPURIFIER_4_PRO,\n",
                "]\n",
                "MODELS_PURIFIER_MIIO = [\n",
                "    MODEL_AIRPURIFIER_V1,\n",
                "    MODEL_AIRPURIFIER_V2,\n",
                "    MODEL_AIRPURIFIER_V3,\n",
                "    MODEL_AIRPURIFIER_V5,\n",
                "    MODEL_AIRPURIFIER_PRO,\n",
                "    MODEL_AIRPURIFIER_PRO_V7,\n",
                "    MODEL_AIRPURIFIER_M1,\n",
                "    MODEL_AIRPURIFIER_M2,\n",
                "    MODEL_AIRPURIFIER_MA1,\n",
                "    MODEL_AIRPURIFIER_MA2,\n",
                "    MODEL_AIRPURIFIER_SA1,\n",
                "    MODEL_AIRPURIFIER_SA2,\n",
                "    MODEL_AIRPURIFIER_2S,\n",
                "    MODEL_AIRPURIFIER_2H,\n",
                "    MODEL_AIRFRESH_A1,\n",
                "    MODEL_AIRFRESH_VA2,\n",
                "    MODEL_AIRFRESH_VA4,\n",
                "    MODEL_AIRFRESH_T2017,\n",
                "]\n",
                "MODELS_HUMIDIFIER_MIIO = [\n",
                "    MODEL_AIRHUMIDIFIER_V1,\n",
                "    MODEL_AIRHUMIDIFIER_CA1,\n",
                "    MODEL_AIRHUMIDIFIER_CB1,\n",
                "]\n",
                "MODELS_HUMIDIFIER_MIOT = [MODEL_AIRHUMIDIFIER_CA4]\n",
                "MODELS_HUMIDIFIER_MJJSQ = [\n",
                "    MODEL_AIRHUMIDIFIER_JSQ,\n",
                "    MODEL_AIRHUMIDIFIER_JSQ1,\n",
                "    MODEL_AIRHUMIDIFIER_MJJSQ,\n",
                "]\n",
                "\n",
                "# AirQuality Models\n",
                "MODEL_AIRQUALITYMONITOR_V1 = \"zhimi.airmonitor.v1\"\n",
                "MODEL_AIRQUALITYMONITOR_B1 = \"cgllc.airmonitor.b1\"\n",
                "MODEL_AIRQUALITYMONITOR_S1 = \"cgllc.airmonitor.s1\"\n",
                "MODEL_AIRQUALITYMONITOR_CGDN1 = \"cgllc.airm.cgdn1\"\n",
                "\n",
                "MODELS_AIR_QUALITY_MONITOR = [\n",
                "    MODEL_AIRQUALITYMONITOR_V1,\n",
                "    MODEL_AIRQUALITYMONITOR_B1,\n",
                "    MODEL_AIRQUALITYMONITOR_S1,\n",
                "    MODEL_AIRQUALITYMONITOR_CGDN1,\n",
                "]\n",
                "\n",
                "# Light Models\n",
                "MODELS_LIGHT_EYECARE = [\"philips.light.sread1\"]\n",
                "MODELS_LIGHT_CEILING = [\"philips.light.ceiling\", \"philips.light.zyceiling\"]\n",
                "MODELS_LIGHT_MOON = [\"philips.light.moonlight\"]\n",
                "MODELS_LIGHT_BULB = [\n",
                "    \"philips.light.bulb\",\n",
                "    \"philips.light.candle\",\n",
                "    \"philips.light.candle2\",\n",
                "    \"philips.light.downlight\",\n",
                "]\n",
                "MODELS_LIGHT_MONO = [\n",
                "    \"philips.light.mono1\",\n",
                "    \"philips.light.hbulb\",\n",
                "]\n",
                "\n",
                "# Model lists\n",
                "MODELS_GATEWAY = [\"lumi.gateway\", \"lumi.acpartner\"]\n",
                "MODELS_SWITCH = [\n",
                "    \"chuangmi.plug.v1\",\n",
                "    \"chuangmi.plug.v3\",\n",
                "    \"chuangmi.plug.hmi208\",\n",
                "    \"qmi.powerstrip.v1\",\n",
                "    \"zimi.powerstrip.v2\",\n",
                "    \"chuangmi.plug.m1\",\n",
                "    \"chuangmi.plug.m3\",\n",
                "    \"chuangmi.plug.v2\",\n",
                "    \"chuangmi.plug.hmi205\",\n",
                "    \"chuangmi.plug.hmi206\",\n",
                "]\n",
                "MODELS_FAN = (\n",
                "    MODELS_PURIFIER_MIIO + MODELS_PURIFIER_MIOT + MODELS_FAN_MIIO + MODELS_FAN_MIOT\n",
                ")\n",
                "MODELS_HUMIDIFIER = (\n",
                "    MODELS_HUMIDIFIER_MIOT + MODELS_HUMIDIFIER_MIIO + MODELS_HUMIDIFIER_MJJSQ\n",
                ")\n",
                "MODELS_LIGHT = (\n",
                "    MODELS_LIGHT_EYECARE\n",
                "    + MODELS_LIGHT_CEILING\n",
                "    + MODELS_LIGHT_MOON\n",
                "    + MODELS_LIGHT_BULB\n",
                "    + MODELS_LIGHT_MONO\n",
                ")\n",
                "\n",
                "# TODO: use const from pythonmiio once new release with the constant has been published. # pylint: disable=fixme\n",
                "ROCKROBO_S4 = \"roborock.vacuum.s4\"\n",
                "ROCKROBO_S4_MAX = \"roborock.vacuum.a19\"\n",
                "ROCKROBO_S5_MAX = \"roborock.vacuum.s5e\"\n",
                "ROCKROBO_S6_PURE = \"roborock.vacuum.a08\"\n",
                "ROCKROBO_E2 = \"roborock.vacuum.e2\"\n",
                "ROBOROCK_GENERIC = \"roborock.vacuum\"\n",
                "ROCKROBO_GENERIC = \"rockrobo.vacuum\"\n",
                "MODELS_VACUUM = [\n",
                "    ROCKROBO_V1,\n",
                "    ROCKROBO_E2,\n",
                "    ROCKROBO_S4,\n",
                "    ROCKROBO_S4_MAX,\n",
                "    ROCKROBO_S5,\n",
                "    ROCKROBO_S5_MAX,\n",
                "    ROCKROBO_S6,\n",
                "    ROCKROBO_S6_MAXV,\n",
                "    ROCKROBO_S6_PURE,\n",
                "    ROCKROBO_S7,\n",
                "    ROBOROCK_GENERIC,\n",
                "    ROCKROBO_GENERIC,\n",
                "]\n",
                "MODELS_VACUUM_WITH_MOP = [\n",
                "    ROCKROBO_E2,\n",
                "    ROCKROBO_S5,\n",
                "    ROCKROBO_S5_MAX,\n",
                "    ROCKROBO_S6,\n",
                "    ROCKROBO_S6_MAXV,\n",
                "    ROCKROBO_S6_PURE,\n",
                "    ROCKROBO_S7,\n",
                "]\n",
                "MODELS_VACUUM_WITH_SEPARATE_MOP = [\n",
                "    ROCKROBO_S7,\n",
                "]\n",
                "\n",
                "MODELS_AIR_MONITOR = [\n",
                "    MODEL_AIRQUALITYMONITOR_V1,\n",
                "    MODEL_AIRQUALITYMONITOR_B1,\n",
                "    MODEL_AIRQUALITYMONITOR_S1,\n",
                "    MODEL_AIRQUALITYMONITOR_CGDN1,\n",
                "]\n",
                "\n",
                "MODELS_ALL_DEVICES = (\n",
                "    MODELS_SWITCH\n",
                "    + MODELS_VACUUM\n",
                "    + MODELS_AIR_MONITOR\n",
                "    + MODELS_FAN\n",
                "    + MODELS_HUMIDIFIER\n",
                "    + MODELS_LIGHT\n",
                ")\n",
                "MODELS_ALL = MODELS_ALL_DEVICES + MODELS_GATEWAY\n",
                "\n",
                "# Fan/Humidifier Services\n",
                "SERVICE_SET_FAVORITE_LEVEL = \"fan_set_favorite_level\"\n",
                "SERVICE_SET_FAN_LEVEL = \"fan_set_fan_level\"\n",
                "SERVICE_SET_VOLUME = \"fan_set_volume\"\n",
                "SERVICE_RESET_FILTER = \"fan_reset_filter\"\n",
                "SERVICE_SET_EXTRA_FEATURES = \"fan_set_extra_features\"\n",
                "SERVICE_SET_DRY = \"set_dry\"\n",
                "SERVICE_SET_MOTOR_SPEED = \"fan_set_motor_speed\"\n",
                "\n",
                "# Light Services\n",
                "SERVICE_SET_SCENE = \"light_set_scene\"\n",
                "SERVICE_SET_DELAYED_TURN_OFF = \"light_set_delayed_turn_off\"\n",
                "SERVICE_REMINDER_ON = \"light_reminder_on\"\n",
                "SERVICE_REMINDER_OFF = \"light_reminder_off\"\n",
                "SERVICE_NIGHT_LIGHT_MODE_ON = \"light_night_light_mode_on\"\n",
                "SERVICE_NIGHT_LIGHT_MODE_OFF = \"light_night_light_mode_off\"\n",
                "SERVICE_EYECARE_MODE_ON = \"light_eyecare_mode_on\"\n",
                "SERVICE_EYECARE_MODE_OFF = \"light_eyecare_mode_off\"\n",
                "\n",
                "# Remote Services\n",
                "SERVICE_LEARN = \"remote_learn_command\"\n",
                "SERVICE_SET_REMOTE_LED_ON = \"remote_set_led_on\"\n",
                "SERVICE_SET_REMOTE_LED_OFF = \"remote_set_led_off\"\n",
                "\n",
                "# Switch Services\n",
                "SERVICE_SET_WIFI_LED_ON = \"switch_set_wifi_led_on\"\n",
                "SERVICE_SET_WIFI_LED_OFF = \"switch_set_wifi_led_off\"\n",
                "SERVICE_SET_POWER_MODE = \"switch_set_power_mode\"\n",
                "SERVICE_SET_POWER_PRICE = \"switch_set_power_price\"\n",
                "\n",
                "# Vacuum Services\n",
                "SERVICE_MOVE_REMOTE_CONTROL = \"vacuum_remote_control_move\"\n",
                "SERVICE_MOVE_REMOTE_CONTROL_STEP = \"vacuum_remote_control_move_step\"\n",
                "SERVICE_START_REMOTE_CONTROL = \"vacuum_remote_control_start\"\n",
                "SERVICE_STOP_REMOTE_CONTROL = \"vacuum_remote_control_stop\"\n",
                "SERVICE_CLEAN_SEGMENT = \"vacuum_clean_segment\"\n",
                "SERVICE_CLEAN_ZONE = \"vacuum_clean_zone\"\n",
                "SERVICE_GOTO = \"vacuum_goto\"\n",
                "\n",
                "# Features\n",
                "FEATURE_SET_BUZZER = 1\n",
                "FEATURE_SET_LED = 2\n",
                "FEATURE_SET_CHILD_LOCK = 4\n",
                "FEATURE_SET_LED_BRIGHTNESS = 8\n",
                "FEATURE_SET_FAVORITE_LEVEL = 16\n",
                "FEATURE_SET_AUTO_DETECT = 32\n",
                "FEATURE_SET_LEARN_MODE = 64\n",
                "FEATURE_SET_VOLUME = 128\n",
                "FEATURE_RESET_FILTER = 256\n",
                "FEATURE_SET_EXTRA_FEATURES = 512\n",
                "FEATURE_SET_TARGET_HUMIDITY = 1024\n",
                "FEATURE_SET_DRY = 2048\n",
                "FEATURE_SET_FAN_LEVEL = 4096\n",
                "FEATURE_SET_MOTOR_SPEED = 8192\n",
                "FEATURE_SET_CLEAN = 16384\n",
                "FEATURE_SET_OSCILLATION_ANGLE = 32768\n",
                "FEATURE_SET_DELAY_OFF_COUNTDOWN = 65536\n",
                "FEATURE_SET_LED_BRIGHTNESS_LEVEL = 131072\n",
                "FEATURE_SET_FAVORITE_RPM = 262144\n",
                "FEATURE_SET_IONIZER = 524288\n",
                "FEATURE_SET_DISPLAY = 1048576\n",
                "FEATURE_SET_PTC = 2097152\n",
                "FEATURE_SET_ANION = 4194304\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_MIIO = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                "    | FEATURE_SET_LEARN_MODE\n",
                "    | FEATURE_RESET_FILTER\n",
                "    | FEATURE_SET_EXTRA_FEATURES\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_MIOT = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                "    | FEATURE_SET_FAN_LEVEL\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_4 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                "    | FEATURE_SET_FAN_LEVEL\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                "    | FEATURE_SET_ANION\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_3C = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED_BRIGHTNESS_LEVEL\n",
                "    | FEATURE_SET_FAVORITE_RPM\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_PRO = (\n",
                "    FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                "    | FEATURE_SET_VOLUME\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_PRO_V7 = (\n",
                "    FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                "    | FEATURE_SET_VOLUME\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_2S = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_FAVORITE_LEVEL\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_V1 = FEATURE_FLAGS_AIRPURIFIER_MIIO | FEATURE_SET_AUTO_DETECT\n",
                "\n",
                "FEATURE_FLAGS_AIRPURIFIER_V3 = (\n",
                "    FEATURE_SET_BUZZER | FEATURE_SET_CHILD_LOCK | FEATURE_SET_LED\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRHUMIDIFIER = (\n",
                "    FEATURE_SET_BUZZER | FEATURE_SET_CHILD_LOCK | FEATURE_SET_TARGET_HUMIDITY\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRHUMIDIFIER_CA_AND_CB = FEATURE_FLAGS_AIRHUMIDIFIER | FEATURE_SET_DRY\n",
                "\n",
                "FEATURE_FLAGS_AIRHUMIDIFIER_MJSSQ = (\n",
                "    FEATURE_SET_BUZZER | FEATURE_SET_LED | FEATURE_SET_TARGET_HUMIDITY\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRHUMIDIFIER_CA4 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_TARGET_HUMIDITY\n",
                "    | FEATURE_SET_DRY\n",
                "    | FEATURE_SET_MOTOR_SPEED\n",
                "    | FEATURE_SET_CLEAN\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRFRESH_A1 = (\n",
                "    FEATURE_SET_BUZZER | FEATURE_SET_CHILD_LOCK | FEATURE_SET_DISPLAY | FEATURE_SET_PTC\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRFRESH = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                "    | FEATURE_RESET_FILTER\n",
                "    | FEATURE_SET_EXTRA_FEATURES\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRFRESH_VA4 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                "    | FEATURE_RESET_FILTER\n",
                "    | FEATURE_SET_EXTRA_FEATURES\n",
                "    | FEATURE_SET_PTC\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_AIRFRESH_T2017 = (\n",
                "    FEATURE_SET_BUZZER | FEATURE_SET_CHILD_LOCK | FEATURE_SET_DISPLAY | FEATURE_SET_PTC\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN_P5 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_OSCILLATION_ANGLE\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_OSCILLATION_ANGLE\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN_ZA5 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_OSCILLATION_ANGLE\n",
                "    | FEATURE_SET_LED_BRIGHTNESS\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                "    | FEATURE_SET_IONIZER\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN_1C = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN_P9 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_OSCILLATION_ANGLE\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                ")\n",
                "\n",
                "FEATURE_FLAGS_FAN_P10_P11 = (\n",
                "    FEATURE_SET_BUZZER\n",
                "    | FEATURE_SET_CHILD_LOCK\n",
                "    | FEATURE_SET_OSCILLATION_ANGLE\n",
                "    | FEATURE_SET_LED\n",
                "    | FEATURE_SET_DELAY_OFF_COUNTDOWN\n",
                ")"
            ]
        ],
        "homeassistant/components/xiaomi_miio/fan.py": [
            [
                "\"\"\"Support for Xiaomi Mi Air Purifier and Xiaomi Mi Air Humidifier.\"\"\"\n",
                "from __future__ import annotations\n",
                "\n",
                "from abc import abstractmethod\n",
                "import asyncio\n",
                "import logging\n",
                "import math\n",
                "from typing import Any\n",
                "\n",
                "from miio.fan_common import (\n",
                "    MoveDirection as FanMoveDirection,\n",
                "    OperationMode as FanOperationMode,\n",
                ")\n",
                "from miio.integrations.airpurifier.dmaker.airfresh_t2017 import (\n",
                "    OperationMode as AirfreshOperationModeT2017,\n",
                ")\n",
                "from miio.integrations.airpurifier.zhimi.airfresh import (\n",
                "    OperationMode as AirfreshOperationMode,\n",
                ")\n",
                "from miio.integrations.airpurifier.zhimi.airpurifier import (\n",
                "    OperationMode as AirpurifierOperationMode,\n",
                ")\n",
                "from miio.integrations.airpurifier.zhimi.airpurifier_miot import (\n",
                "    OperationMode as AirpurifierMiotOperationMode,\n",
                ")\n",
                "from miio.integrations.fan.zhimi.zhimi_miot import (\n",
                "    OperationModeFanZA5 as FanZA5OperationMode,\n",
                ")\n",
                "import voluptuous as vol\n",
                "\n",
                "from homeassistant.components.fan import FanEntity, FanEntityFeature\n",
                "from homeassistant.config_entries import ConfigEntry\n",
                "from homeassistant.const import ATTR_ENTITY_ID, CONF_MODEL\n",
                "from homeassistant.core import HomeAssistant, ServiceCall, callback\n",
                "import homeassistant.helpers.config_validation as cv\n",
                "from homeassistant.helpers.entity_platform import AddEntitiesCallback\n",
                "from homeassistant.util.percentage import (\n",
                "    percentage_to_ranged_value,\n",
                "    ranged_value_to_percentage,\n",
                ")\n",
                "\n",
                "from .const import (\n",
                "    CONF_DEVICE,\n",
                "    CONF_FLOW_TYPE,\n",
                "    DOMAIN,\n",
                "    FEATURE_FLAGS_AIRFRESH,\n",
                "    FEATURE_FLAGS_AIRFRESH_A1,\n",
                "    FEATURE_FLAGS_AIRFRESH_T2017,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_2S,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_3C,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_4,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_MIIO,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_MIOT,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_PRO,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_PRO_V7,\n",
                "    FEATURE_FLAGS_AIRPURIFIER_V3,\n",
                "    FEATURE_FLAGS_FAN,\n",
                "    FEATURE_FLAGS_FAN_1C,\n",
                "    FEATURE_FLAGS_FAN_P5,\n",
                "    FEATURE_FLAGS_FAN_P9,\n",
                "    FEATURE_FLAGS_FAN_P10_P11,\n",
                "    FEATURE_FLAGS_FAN_ZA5,\n",
                "    FEATURE_RESET_FILTER,\n",
                "    FEATURE_SET_EXTRA_FEATURES,\n",
                "    KEY_COORDINATOR,\n",
                "    KEY_DEVICE,\n",
                "    MODEL_AIRFRESH_A1,\n",
                "    MODEL_AIRFRESH_T2017,\n",
                "    MODEL_AIRPURIFIER_2H,\n",
                "    MODEL_AIRPURIFIER_2S,\n",
                "    MODEL_AIRPURIFIER_3C,\n",
                "    MODEL_AIRPURIFIER_4,\n",
                "    MODEL_AIRPURIFIER_4_PRO,\n",
                "    MODEL_AIRPURIFIER_PRO,\n",
                "    MODEL_AIRPURIFIER_PRO_V7,\n",
                "    MODEL_AIRPURIFIER_V3,\n",
                "    MODEL_FAN_1C,\n",
                "    MODEL_FAN_P5,\n",
                "    MODEL_FAN_P9,\n",
                "    MODEL_FAN_P10,\n",
                "    MODEL_FAN_P11,\n",
                "    MODEL_FAN_ZA5,\n",
                "    MODELS_FAN_MIIO,\n",
                "    MODELS_FAN_MIOT,\n",
                "    MODELS_PURIFIER_MIOT,\n",
                "    SERVICE_RESET_FILTER,\n",
                "    SERVICE_SET_EXTRA_FEATURES,\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    SPEEDS_FAN_MIOT,\n"
                ],
                "parent_version_range": {
                    "start": 87,
                    "end": 87
                },
                "child_version_range": {
                    "start": 87,
                    "end": 88
                },
                "control_flow": [],
                "structural_path": [],
                "idx": 1,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n  ...\n84 84        MODELS_PURIFIER_MIOT,\n85 85        SERVICE_RESET_FILTER,\n86 86        SERVICE_SET_EXTRA_FEATURES,\n   87  +     SPEEDS_FAN_MIOT,\n87 88    )\n88 89    from .device import XiaomiCoordinatedMiioEntity\n89 90    \n       ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "SPEEDS_FAN_MIOT"
                ],
                "prefix": [
                    "    MODELS_PURIFIER_MIOT,\n",
                    "    SERVICE_RESET_FILTER,\n",
                    "    SERVICE_SET_EXTRA_FEATURES,\n"
                ],
                "suffix": [
                    ")\n",
                    "from .device import XiaomiCoordinatedMiioEntity\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 0,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 87,
                                    "column": 4
                                },
                                "end": {
                                    "line": 87,
                                    "column": 19
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 1,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 2,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 87,
                                    "column": 4
                                },
                                "end": {
                                    "line": 87,
                                    "column": 19
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 1,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 3,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 87,
                                    "column": 4
                                },
                                "end": {
                                    "line": 87,
                                    "column": 19
                                }
                            },
                            "type": "identifier",
                            "kind": "import",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 1,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                ")\n",
                "from .device import XiaomiCoordinatedMiioEntity\n",
                "\n",
                "_LOGGER = logging.getLogger(__name__)\n",
                "\n",
                "DATA_KEY = \"fan.xiaomi_miio\"\n",
                "\n",
                "ATTR_MODE_NATURE = \"Nature\"\n",
                "ATTR_MODE_NORMAL = \"Normal\"\n",
                "\n",
                "# Air Purifier\n",
                "ATTR_BRIGHTNESS = \"brightness\"\n",
                "ATTR_FAN_LEVEL = \"fan_level\"\n",
                "ATTR_SLEEP_TIME = \"sleep_time\"\n",
                "ATTR_SLEEP_LEARN_COUNT = \"sleep_mode_learn_count\"\n",
                "ATTR_EXTRA_FEATURES = \"extra_features\"\n",
                "ATTR_FEATURES = \"features\"\n",
                "ATTR_TURBO_MODE_SUPPORTED = \"turbo_mode_supported\"\n",
                "ATTR_SLEEP_MODE = \"sleep_mode\"\n",
                "ATTR_USE_TIME = \"use_time\"\n",
                "ATTR_BUTTON_PRESSED = \"button_pressed\"\n",
                "\n",
                "# Air Fresh A1\n",
                "ATTR_FAVORITE_SPEED = \"favorite_speed\"\n",
                "\n",
                "# Map attributes to properties of the state object\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER_COMMON = {\n",
                "    ATTR_EXTRA_FEATURES: \"extra_features\",\n",
                "    ATTR_TURBO_MODE_SUPPORTED: \"turbo_mode_supported\",\n",
                "    ATTR_BUTTON_PRESSED: \"button_pressed\",\n",
                "}\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER = {\n",
                "    **AVAILABLE_ATTRIBUTES_AIRPURIFIER_COMMON,\n",
                "    ATTR_SLEEP_TIME: \"sleep_time\",\n",
                "    ATTR_SLEEP_LEARN_COUNT: \"sleep_mode_learn_count\",\n",
                "    ATTR_USE_TIME: \"use_time\",\n",
                "    ATTR_SLEEP_MODE: \"sleep_mode\",\n",
                "}\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER_PRO = {\n",
                "    **AVAILABLE_ATTRIBUTES_AIRPURIFIER_COMMON,\n",
                "    ATTR_USE_TIME: \"use_time\",\n",
                "    ATTR_SLEEP_TIME: \"sleep_time\",\n",
                "    ATTR_SLEEP_LEARN_COUNT: \"sleep_mode_learn_count\",\n",
                "}\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER_MIOT = {ATTR_USE_TIME: \"use_time\"}\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER_PRO_V7 = AVAILABLE_ATTRIBUTES_AIRPURIFIER_COMMON\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRPURIFIER_V3 = {\n",
                "    # Common set isn't used here. It's a very basic version of the device.\n",
                "    ATTR_SLEEP_TIME: \"sleep_time\",\n",
                "    ATTR_SLEEP_LEARN_COUNT: \"sleep_mode_learn_count\",\n",
                "    ATTR_EXTRA_FEATURES: \"extra_features\",\n",
                "    ATTR_USE_TIME: \"use_time\",\n",
                "    ATTR_BUTTON_PRESSED: \"button_pressed\",\n",
                "}\n",
                "\n",
                "AVAILABLE_ATTRIBUTES_AIRFRESH = {\n",
                "    ATTR_USE_TIME: \"use_time\",\n",
                "    ATTR_EXTRA_FEATURES: \"extra_features\",\n",
                "}\n",
                "\n",
                "PRESET_MODES_AIRPURIFIER = [\"Auto\", \"Silent\", \"Favorite\", \"Idle\"]\n",
                "PRESET_MODES_AIRPURIFIER_MIOT = [\"Auto\", \"Silent\", \"Favorite\", \"Fan\"]\n",
                "PRESET_MODES_AIRPURIFIER_PRO = [\"Auto\", \"Silent\", \"Favorite\"]\n",
                "PRESET_MODES_AIRPURIFIER_PRO_V7 = PRESET_MODES_AIRPURIFIER_PRO\n",
                "PRESET_MODES_AIRPURIFIER_2S = [\"Auto\", \"Silent\", \"Favorite\"]\n",
                "PRESET_MODES_AIRPURIFIER_3C = [\"Auto\", \"Silent\", \"Favorite\"]\n",
                "PRESET_MODES_AIRPURIFIER_V3 = [\n",
                "    \"Auto\",\n",
                "    \"Silent\",\n",
                "    \"Favorite\",\n",
                "    \"Idle\",\n",
                "    \"Medium\",\n",
                "    \"High\",\n",
                "    \"Strong\",\n",
                "]\n",
                "PRESET_MODES_AIRFRESH = [\"Auto\", \"Interval\"]\n",
                "PRESET_MODES_AIRFRESH_A1 = [\"Auto\", \"Sleep\", \"Favorite\"]\n",
                "\n",
                "AIRPURIFIER_SERVICE_SCHEMA = vol.Schema({vol.Optional(ATTR_ENTITY_ID): cv.entity_ids})\n",
                "\n",
                "SERVICE_SCHEMA_EXTRA_FEATURES = AIRPURIFIER_SERVICE_SCHEMA.extend(\n",
                "    {vol.Required(ATTR_FEATURES): cv.positive_int}\n",
                ")\n",
                "\n",
                "SERVICE_TO_METHOD = {\n",
                "    SERVICE_RESET_FILTER: {\"method\": \"async_reset_filter\"},\n",
                "    SERVICE_SET_EXTRA_FEATURES: {\n",
                "        \"method\": \"async_set_extra_features\",\n",
                "        \"schema\": SERVICE_SCHEMA_EXTRA_FEATURES,\n",
                "    },\n",
                "}\n",
                "\n",
                "FAN_DIRECTIONS_MAP = {\n",
                "    \"forward\": \"right\",\n",
                "    \"reverse\": \"left\",\n",
                "}\n",
                "\n",
                "\n",
                "async def async_setup_entry(\n",
                "    hass: HomeAssistant,\n",
                "    config_entry: ConfigEntry,\n",
                "    async_add_entities: AddEntitiesCallback,\n",
                ") -> None:\n",
                "    \"\"\"Set up the Fan from a config entry.\"\"\"\n",
                "    entities: list[FanEntity] = []\n",
                "    entity: FanEntity\n",
                "\n",
                "    if not config_entry.data[CONF_FLOW_TYPE] == CONF_DEVICE:\n",
                "        return\n",
                "\n",
                "    hass.data.setdefault(DATA_KEY, {})\n",
                "\n",
                "    model = config_entry.data[CONF_MODEL]\n",
                "    unique_id = config_entry.unique_id\n",
                "    coordinator = hass.data[DOMAIN][config_entry.entry_id][KEY_COORDINATOR]\n",
                "    device = hass.data[DOMAIN][config_entry.entry_id][KEY_DEVICE]\n",
                "\n",
                "    if model == MODEL_AIRPURIFIER_3C:\n",
                "        entity = XiaomiAirPurifierMB4(\n",
                "            device,\n",
                "            config_entry,\n",
                "            unique_id,\n",
                "            coordinator,\n",
                "        )\n",
                "    elif model in MODELS_PURIFIER_MIOT:\n",
                "        entity = XiaomiAirPurifierMiot(\n",
                "            device,\n",
                "            config_entry,\n",
                "            unique_id,\n",
                "            coordinator,\n",
                "        )\n",
                "    elif model.startswith(\"zhimi.airpurifier.\"):\n",
                "        entity = XiaomiAirPurifier(device, config_entry, unique_id, coordinator)\n",
                "    elif model.startswith(\"zhimi.airfresh.\"):\n",
                "        entity = XiaomiAirFresh(device, config_entry, unique_id, coordinator)\n",
                "    elif model == MODEL_AIRFRESH_A1:\n",
                "        entity = XiaomiAirFreshA1(device, config_entry, unique_id, coordinator)\n",
                "    elif model == MODEL_AIRFRESH_T2017:\n",
                "        entity = XiaomiAirFreshT2017(device, config_entry, unique_id, coordinator)\n",
                "    elif model == MODEL_FAN_P5:\n",
                "        entity = XiaomiFanP5(device, config_entry, unique_id, coordinator)\n",
                "    elif model in MODELS_FAN_MIIO:\n",
                "        entity = XiaomiFan(device, config_entry, unique_id, coordinator)\n",
                "    elif model == MODEL_FAN_ZA5:\n"
            ],
            {
                "type": "replace",
                "before": [
                    "        entity = XiaomiFanZA5(device, config_entry, unique_id, coordinator)\n"
                ],
                "after": [
                    "        speed_count = SPEEDS_FAN_MIOT[model]\n",
                    "        entity = XiaomiFanZA5(device, config_entry, unique_id, coordinator, speed_count)\n"
                ],
                "parent_version_range": {
                    "start": 236,
                    "end": 237
                },
                "child_version_range": {
                    "start": 237,
                    "end": 239
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if model == MODEL_AIRPURIFIER_3C:",
                        "start_line": 209,
                        "end_line": 240
                    }
                ],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "async_setup_entry",
                        "signature": "def async_setup_entry(\n    hass: HomeAssistant,\n    config_entry: ConfigEntry,\n    async_add_entities: AddEntitiesCallback,\n)->None:",
                        "at_line": 190
                    }
                ],
                "idx": 2,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n           def async_setup_entry(\n    hass: HomeAssistant,\n    config_entry: ConfigEntry,\n    async_add_entities: AddEntitiesCallback,\n)->None:\n               ...\n233 234        elif model in MODELS_FAN_MIIO:\n234 235            entity = XiaomiFan(device, config_entry, unique_id, coordinator)\n235 236        elif model == MODEL_FAN_ZA5:\n236      -         entity = XiaomiFanZA5(device, config_entry, unique_id, coordinator)\n    237  +         speed_count = SPEEDS_FAN_MIOT[model]\n    238  +         entity = XiaomiFanZA5(device, config_entry, unique_id, coordinator, speed_count)\n237 239        elif model in MODELS_FAN_MIOT:\n         ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "XiaomiFanZA5",
                    "config_entry",
                    "coordinator",
                    "device",
                    "entity",
                    "unique_id"
                ],
                "identifiers_after": [
                    "SPEEDS_FAN_MIOT",
                    "XiaomiFanZA5",
                    "config_entry",
                    "coordinator",
                    "device",
                    "entity",
                    "model",
                    "speed_count",
                    "unique_id"
                ],
                "prefix": [
                    "    elif model in MODELS_FAN_MIIO:\n",
                    "        entity = XiaomiFan(device, config_entry, unique_id, coordinator)\n",
                    "    elif model == MODEL_FAN_ZA5:\n"
                ],
                "suffix": [
                    "    elif model in MODELS_FAN_MIOT:\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 0,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 237,
                                    "column": 22
                                },
                                "end": {
                                    "line": 237,
                                    "column": 37
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 1,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 237,
                                    "column": 22
                                },
                                "end": {
                                    "line": 237,
                                    "column": 37
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 2,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": [
                    3
                ]
            },
            [
                "    elif model in MODELS_FAN_MIOT:\n"
            ],
            {
                "type": "replace",
                "before": [
                    "        entity = XiaomiFanMiot(device, config_entry, unique_id, coordinator)\n"
                ],
                "after": [
                    "        speed_count = SPEEDS_FAN_MIOT[model]\n",
                    "        entity = XiaomiFanMiot(\n",
                    "            device, config_entry, unique_id, coordinator, speed_count\n",
                    "        )\n"
                ],
                "parent_version_range": {
                    "start": 238,
                    "end": 239
                },
                "child_version_range": {
                    "start": 240,
                    "end": 244
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if model == MODEL_AIRPURIFIER_3C:",
                        "start_line": 209,
                        "end_line": 240
                    }
                ],
                "structural_path": [
                    {
                        "type": "function",
                        "name": "async_setup_entry",
                        "signature": "def async_setup_entry(\n    hass: HomeAssistant,\n    config_entry: ConfigEntry,\n    async_add_entities: AddEntitiesCallback,\n)->None:",
                        "at_line": 190
                    }
                ],
                "idx": 3,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n           def async_setup_entry(\n    hass: HomeAssistant,\n    config_entry: ConfigEntry,\n    async_add_entities: AddEntitiesCallback,\n)->None:\n               ...\n237 239        elif model in MODELS_FAN_MIOT:\n238      -         entity = XiaomiFanMiot(device, config_entry, unique_id, coordinator)\n    240  +         speed_count = SPEEDS_FAN_MIOT[model]\n    241  +         entity = XiaomiFanMiot(\n    242  +             device, config_entry, unique_id, coordinator, speed_count\n    243  +         )\n239 244        else:\n240 245            return\n241 246    \n         ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "XiaomiFanMiot",
                    "config_entry",
                    "coordinator",
                    "device",
                    "entity",
                    "unique_id"
                ],
                "identifiers_after": [
                    "SPEEDS_FAN_MIOT",
                    "XiaomiFanMiot",
                    "config_entry",
                    "coordinator",
                    "device",
                    "entity",
                    "model",
                    "speed_count",
                    "unique_id"
                ],
                "prefix": [
                    "    elif model in MODELS_FAN_MIOT:\n"
                ],
                "suffix": [
                    "    else:\n",
                    "        return\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 0,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 240,
                                    "column": 22
                                },
                                "end": {
                                    "line": 240,
                                    "column": 37
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 1,
                        "detail": {
                            "identifier": "SPEEDS_FAN_MIOT",
                            "position": {
                                "start": {
                                    "line": 240,
                                    "column": 22
                                },
                                "end": {
                                    "line": 240,
                                    "column": 37
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 3,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": [
                    2
                ]
            },
            [
                "    else:\n",
                "        return\n",
                "\n",
                "    hass.data[DATA_KEY][unique_id] = entity\n",
                "\n",
                "    entities.append(entity)\n",
                "\n",
                "    async def async_service_handler(service: ServiceCall) -> None:\n",
                "        \"\"\"Map services to methods on XiaomiAirPurifier.\"\"\"\n",
                "        method = SERVICE_TO_METHOD[service.service]\n",
                "        params = {\n",
                "            key: value for key, value in service.data.items() if key != ATTR_ENTITY_ID\n",
                "        }\n",
                "        if entity_ids := service.data.get(ATTR_ENTITY_ID):\n",
                "            filtered_entities = [\n",
                "                entity\n",
                "                for entity in hass.data[DATA_KEY].values()\n",
                "                if entity.entity_id in entity_ids\n",
                "            ]\n",
                "        else:\n",
                "            filtered_entities = hass.data[DATA_KEY].values()\n",
                "\n",
                "        update_tasks = []\n",
                "\n",
                "        for entity in filtered_entities:\n",
                "            entity_method = getattr(entity, method[\"method\"], None)\n",
                "            if not entity_method:\n",
                "                continue\n",
                "            await entity_method(**params)\n",
                "            update_tasks.append(\n",
                "                hass.async_create_task(entity.async_update_ha_state(True))\n",
                "            )\n",
                "\n",
                "        if update_tasks:\n",
                "            await asyncio.wait(update_tasks)\n",
                "\n",
                "    for air_purifier_service, method in SERVICE_TO_METHOD.items():\n",
                "        schema = method.get(\"schema\", AIRPURIFIER_SERVICE_SCHEMA)\n",
                "        hass.services.async_register(\n",
                "            DOMAIN, air_purifier_service, async_service_handler, schema=schema\n",
                "        )\n",
                "\n",
                "    async_add_entities(entities)\n",
                "\n",
                "\n",
                "class XiaomiGenericDevice(XiaomiCoordinatedMiioEntity, FanEntity):\n",
                "    \"\"\"Representation of a generic Xiaomi device.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the generic Xiaomi device.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._available_attributes = {}\n",
                "        self._state = None\n",
                "        self._mode = None\n",
                "        self._fan_level = None\n",
                "        self._state_attrs = {}\n",
                "        self._device_features = 0\n",
                "        self._preset_modes = []\n",
                "\n",
                "    @property\n",
                "    @abstractmethod\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "\n",
                "    @property\n",
                "    def preset_modes(self) -> list[str]:\n",
                "        \"\"\"Get the list of available preset modes.\"\"\"\n",
                "        return self._preset_modes\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the percentage based speed of the fan.\"\"\"\n",
                "        return None\n",
                "\n",
                "    @property\n",
                "    def extra_state_attributes(self) -> dict[str, Any]:\n",
                "        \"\"\"Return the state attributes of the device.\"\"\"\n",
                "        return self._state_attrs\n",
                "\n",
                "    @property\n",
                "    def is_on(self) -> bool | None:\n",
                "        \"\"\"Return true if device is on.\"\"\"\n",
                "        return self._state\n",
                "\n",
                "    async def async_turn_on(\n",
                "        self,\n",
                "        percentage: int | None = None,\n",
                "        preset_mode: str | None = None,\n",
                "        **kwargs: Any,\n",
                "    ) -> None:\n",
                "        \"\"\"Turn the device on.\"\"\"\n",
                "        result = await self._try_command(\n",
                "            \"Turning the miio device on failed.\", self._device.on\n",
                "        )\n",
                "\n",
                "        # If operation mode was set the device must not be turned on.\n",
                "        if percentage:\n",
                "            await self.async_set_percentage(percentage)\n",
                "        if preset_mode:\n",
                "            await self.async_set_preset_mode(preset_mode)\n",
                "\n",
                "        if result:\n",
                "            self._state = True\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_turn_off(self, **kwargs: Any) -> None:\n",
                "        \"\"\"Turn the device off.\"\"\"\n",
                "        result = await self._try_command(\n",
                "            \"Turning the miio device off failed.\", self._device.off\n",
                "        )\n",
                "\n",
                "        if result:\n",
                "            self._state = False\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiGenericAirPurifier(XiaomiGenericDevice):\n",
                "    \"\"\"Representation of a generic AirPurifier device.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the generic AirPurifier device.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._speed_count = 100\n",
                "\n",
                "    @property\n",
                "    def speed_count(self) -> int:\n",
                "        \"\"\"Return the number of speeds of the fan supported.\"\"\"\n",
                "        return self._speed_count\n",
                "\n",
                "    @property\n",
                "    def preset_mode(self) -> str | None:\n",
                "        \"\"\"Get the active preset mode.\"\"\"\n",
                "        if self._state:\n",
                "            preset_mode = self.operation_mode_class(self._mode).name\n",
                "            return preset_mode if preset_mode in self._preset_modes else None\n",
                "\n",
                "        return None\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._state_attrs.update(\n",
                "            {\n",
                "                key: self._extract_value_from_attribute(self.coordinator.data, value)\n",
                "                for key, value in self._available_attributes.items()\n",
                "            }\n",
                "        )\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "        self._fan_level = getattr(self.coordinator.data, ATTR_FAN_LEVEL, None)\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiAirPurifier(XiaomiGenericAirPurifier):\n",
                "    \"\"\"Representation of a Xiaomi Air Purifier.\"\"\"\n",
                "\n",
                "    SPEED_MODE_MAPPING = {\n",
                "        1: AirpurifierOperationMode.Silent,\n",
                "        2: AirpurifierOperationMode.Medium,\n",
                "        3: AirpurifierOperationMode.High,\n",
                "        4: AirpurifierOperationMode.Strong,\n",
                "    }\n",
                "\n",
                "    REVERSE_SPEED_MODE_MAPPING = {v: k for k, v in SPEED_MODE_MAPPING.items()}\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the plug switch.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        if self._model == MODEL_AIRPURIFIER_PRO:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_PRO\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_PRO\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_PRO\n",
                "            self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "            self._speed_count = 1\n",
                "        elif self._model in [MODEL_AIRPURIFIER_4, MODEL_AIRPURIFIER_4_PRO]:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_4\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_MIOT\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_MIOT\n",
                "            self._attr_supported_features = (\n",
                "                FanEntityFeature.SET_SPEED | FanEntityFeature.PRESET_MODE\n",
                "            )\n",
                "            self._speed_count = 3\n",
                "        elif self._model == MODEL_AIRPURIFIER_PRO_V7:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_PRO_V7\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_PRO_V7\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_PRO_V7\n",
                "            self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "            self._speed_count = 1\n",
                "        elif self._model in [MODEL_AIRPURIFIER_2S, MODEL_AIRPURIFIER_2H]:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_2S\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_COMMON\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_2S\n",
                "            self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "            self._speed_count = 1\n",
                "        elif self._model in MODELS_PURIFIER_MIOT:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_MIOT\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_MIOT\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_MIOT\n",
                "            self._attr_supported_features = (\n",
                "                FanEntityFeature.SET_SPEED | FanEntityFeature.PRESET_MODE\n",
                "            )\n",
                "            self._speed_count = 3\n",
                "        elif self._model == MODEL_AIRPURIFIER_V3:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_V3\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER_V3\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER_V3\n",
                "            self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "            self._speed_count = 1\n",
                "        else:\n",
                "            self._device_features = FEATURE_FLAGS_AIRPURIFIER_MIIO\n",
                "            self._available_attributes = AVAILABLE_ATTRIBUTES_AIRPURIFIER\n",
                "            self._preset_modes = PRESET_MODES_AIRPURIFIER\n",
                "            self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "            self._speed_count = 1\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._state_attrs.update(\n",
                "            {\n",
                "                key: self._extract_value_from_attribute(self.coordinator.data, value)\n",
                "                for key, value in self._available_attributes.items()\n",
                "            }\n",
                "        )\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "        self._fan_level = getattr(self.coordinator.data, ATTR_FAN_LEVEL, None)\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return AirpurifierOperationMode\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the current percentage based speed.\"\"\"\n",
                "        if self._state:\n",
                "            mode = self.operation_mode_class(self._mode)\n",
                "            if mode in self.REVERSE_SPEED_MODE_MAPPING:\n",
                "                return ranged_value_to_percentage(\n",
                "                    (1, self._speed_count), self.REVERSE_SPEED_MODE_MAPPING[mode]\n",
                "                )\n",
                "\n",
                "        return None\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\n",
                "\n",
                "        This method is a coroutine.\n",
                "        \"\"\"\n",
                "        if percentage == 0:\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n",
                "        speed_mode = math.ceil(\n",
                "            percentage_to_ranged_value((1, self._speed_count), percentage)\n",
                "        )\n",
                "        if speed_mode:\n",
                "            await self._try_command(\n",
                "                \"Setting operation mode of the miio device failed.\",\n",
                "                self._device.set_mode,\n",
                "                self.operation_mode_class(self.SPEED_MODE_MAPPING[speed_mode]),\n",
                "            )\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\n",
                "\n",
                "        This method is a coroutine.\n",
                "        \"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        ):\n",
                "            self._mode = self.operation_mode_class[preset_mode].value\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_extra_features(self, features: int = 1):\n",
                "        \"\"\"Set the extra features.\"\"\"\n",
                "        if self._device_features & FEATURE_SET_EXTRA_FEATURES == 0:\n",
                "            return\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Setting the extra features of the miio device failed.\",\n",
                "            self._device.set_extra_features,\n",
                "            features,\n",
                "        )\n",
                "\n",
                "    async def async_reset_filter(self):\n",
                "        \"\"\"Reset the filter lifetime and usage.\"\"\"\n",
                "        if self._device_features & FEATURE_RESET_FILTER == 0:\n",
                "            return\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Resetting the filter lifetime of the miio device failed.\",\n",
                "            self._device.reset_filter,\n",
                "        )\n",
                "\n",
                "\n",
                "class XiaomiAirPurifierMiot(XiaomiAirPurifier):\n",
                "    \"\"\"Representation of a Xiaomi Air Purifier (MiOT protocol).\"\"\"\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return AirpurifierMiotOperationMode\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the current percentage based speed.\"\"\"\n",
                "        if self._fan_level is None:\n",
                "            return None\n",
                "        if self._state:\n",
                "            return ranged_value_to_percentage((1, 3), self._fan_level)\n",
                "\n",
                "        return None\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\n",
                "\n",
                "        This method is a coroutine.\n",
                "        \"\"\"\n",
                "        if percentage == 0:\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n",
                "        fan_level = math.ceil(percentage_to_ranged_value((1, 3), percentage))\n",
                "        if not fan_level:\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting fan level of the miio device failed.\",\n",
                "            self._device.set_fan_level,\n",
                "            fan_level,\n",
                "        ):\n",
                "            self._fan_level = fan_level\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiAirPurifierMB4(XiaomiGenericAirPurifier):\n",
                "    \"\"\"Representation of a Xiaomi Air Purifier MB4.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize Air Purifier MB4.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._device_features = FEATURE_FLAGS_AIRPURIFIER_3C\n",
                "        self._preset_modes = PRESET_MODES_AIRPURIFIER_3C\n",
                "        self._attr_supported_features = FanEntityFeature.PRESET_MODE\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return AirpurifierMiotOperationMode\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        ):\n",
                "            self._mode = self.operation_mode_class[preset_mode].value\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiAirFresh(XiaomiGenericAirPurifier):\n",
                "    \"\"\"Representation of a Xiaomi Air Fresh.\"\"\"\n",
                "\n",
                "    SPEED_MODE_MAPPING = {\n",
                "        1: AirfreshOperationMode.Silent,\n",
                "        2: AirfreshOperationMode.Low,\n",
                "        3: AirfreshOperationMode.Middle,\n",
                "        4: AirfreshOperationMode.Strong,\n",
                "    }\n",
                "\n",
                "    REVERSE_SPEED_MODE_MAPPING = {v: k for k, v in SPEED_MODE_MAPPING.items()}\n",
                "\n",
                "    PRESET_MODE_MAPPING = {\n",
                "        \"Auto\": AirfreshOperationMode.Auto,\n",
                "        \"Interval\": AirfreshOperationMode.Interval,\n",
                "    }\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the miio device.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._device_features = FEATURE_FLAGS_AIRFRESH\n",
                "        self._available_attributes = AVAILABLE_ATTRIBUTES_AIRFRESH\n",
                "        self._speed_count = 4\n",
                "        self._preset_modes = PRESET_MODES_AIRFRESH\n",
                "        self._attr_supported_features = (\n",
                "            FanEntityFeature.SET_SPEED | FanEntityFeature.PRESET_MODE\n",
                "        )\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._state_attrs.update(\n",
                "            {\n",
                "                key: getattr(self.coordinator.data, value)\n",
                "                for key, value in self._available_attributes.items()\n",
                "            }\n",
                "        )\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return AirfreshOperationMode\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the current percentage based speed.\"\"\"\n",
                "        if self._state:\n",
                "            mode = AirfreshOperationMode(self._mode)\n",
                "            if mode in self.REVERSE_SPEED_MODE_MAPPING:\n",
                "                return ranged_value_to_percentage(\n",
                "                    (1, self._speed_count), self.REVERSE_SPEED_MODE_MAPPING[mode]\n",
                "                )\n",
                "\n",
                "        return None\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\n",
                "\n",
                "        This method is a coroutine.\n",
                "        \"\"\"\n",
                "        speed_mode = math.ceil(\n",
                "            percentage_to_ranged_value((1, self._speed_count), percentage)\n",
                "        )\n",
                "        if speed_mode:\n",
                "            if await self._try_command(\n",
                "                \"Setting operation mode of the miio device failed.\",\n",
                "                self._device.set_mode,\n",
                "                AirfreshOperationMode(self.SPEED_MODE_MAPPING[speed_mode]),\n",
                "            ):\n",
                "                self._mode = AirfreshOperationMode(\n",
                "                    self.SPEED_MODE_MAPPING[speed_mode]\n",
                "                ).value\n",
                "                self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\n",
                "\n",
                "        This method is a coroutine.\n",
                "        \"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        ):\n",
                "            self._mode = self.operation_mode_class[preset_mode].value\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_extra_features(self, features: int = 1):\n",
                "        \"\"\"Set the extra features.\"\"\"\n",
                "        if self._device_features & FEATURE_SET_EXTRA_FEATURES == 0:\n",
                "            return\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Setting the extra features of the miio device failed.\",\n",
                "            self._device.set_extra_features,\n",
                "            features,\n",
                "        )\n",
                "\n",
                "    async def async_reset_filter(self):\n",
                "        \"\"\"Reset the filter lifetime and usage.\"\"\"\n",
                "        if self._device_features & FEATURE_RESET_FILTER == 0:\n",
                "            return\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Resetting the filter lifetime of the miio device failed.\",\n",
                "            self._device.reset_filter,\n",
                "        )\n",
                "\n",
                "\n",
                "class XiaomiAirFreshA1(XiaomiGenericAirPurifier):\n",
                "    \"\"\"Representation of a Xiaomi Air Fresh A1.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the miio device.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "        self._favorite_speed = None\n",
                "        self._device_features = FEATURE_FLAGS_AIRFRESH_A1\n",
                "        self._preset_modes = PRESET_MODES_AIRFRESH_A1\n",
                "        self._attr_supported_features = (\n",
                "            FanEntityFeature.SET_SPEED | FanEntityFeature.PRESET_MODE\n",
                "        )\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "        self._speed_range = (60, 150)\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return AirfreshOperationModeT2017\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the current percentage based speed.\"\"\"\n",
                "        if self._favorite_speed is None:\n",
                "            return None\n",
                "        if self._state:\n",
                "            return ranged_value_to_percentage(self._speed_range, self._favorite_speed)\n",
                "\n",
                "        return None\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan. This method is a coroutine.\"\"\"\n",
                "        if percentage == 0:\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n",
                "        await self.async_set_preset_mode(\"Favorite\")\n",
                "\n",
                "        favorite_speed = math.ceil(\n",
                "            percentage_to_ranged_value(self._speed_range, percentage)\n",
                "        )\n",
                "        if not favorite_speed:\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting fan level of the miio device failed.\",\n",
                "            self._device.set_favorite_speed,\n",
                "            favorite_speed,\n",
                "        ):\n",
                "            self._favorite_speed = favorite_speed\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan. This method is a coroutine.\"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        if await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        ):\n",
                "            self._mode = self.operation_mode_class[preset_mode].value\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._mode = self.coordinator.data.mode.value\n",
                "        self._favorite_speed = getattr(self.coordinator.data, ATTR_FAVORITE_SPEED, None)\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiAirFreshT2017(XiaomiAirFreshA1):\n",
                "    \"\"\"Representation of a Xiaomi Air Fresh T2017.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the miio device.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "        self._device_features = FEATURE_FLAGS_AIRFRESH_T2017\n",
                "        self._speed_range = (60, 300)\n",
                "\n",
                "\n",
                "class XiaomiGenericFan(XiaomiGenericDevice):\n",
                "    \"\"\"Representation of a generic Xiaomi Fan.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the fan.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        if self._model == MODEL_FAN_P5:\n",
                "            self._device_features = FEATURE_FLAGS_FAN_P5\n",
                "        elif self._model == MODEL_FAN_ZA5:\n",
                "            self._device_features = FEATURE_FLAGS_FAN_ZA5\n",
                "        elif self._model == MODEL_FAN_1C:\n",
                "            self._device_features = FEATURE_FLAGS_FAN_1C\n",
                "        elif self._model == MODEL_FAN_P9:\n",
                "            self._device_features = FEATURE_FLAGS_FAN_P9\n",
                "        elif self._model in (MODEL_FAN_P10, MODEL_FAN_P11):\n",
                "            self._device_features = FEATURE_FLAGS_FAN_P10_P11\n",
                "        else:\n",
                "            self._device_features = FEATURE_FLAGS_FAN\n",
                "        self._attr_supported_features = (\n",
                "            FanEntityFeature.SET_SPEED\n",
                "            | FanEntityFeature.OSCILLATE\n",
                "            | FanEntityFeature.PRESET_MODE\n",
                "        )\n",
                "        if self._model != MODEL_FAN_1C:\n",
                "            self._attr_supported_features |= FanEntityFeature.DIRECTION\n",
                "        self._preset_mode = None\n",
                "        self._oscillating = None\n",
                "        self._percentage = None\n",
                "\n",
                "    @property\n",
                "    def preset_mode(self) -> str | None:\n",
                "        \"\"\"Get the active preset mode.\"\"\"\n",
                "        return self._preset_mode\n",
                "\n",
                "    @property\n",
                "    def preset_modes(self) -> list[str]:\n",
                "        \"\"\"Get the list of available preset modes.\"\"\"\n",
                "        return [mode.name for mode in self.operation_mode_class]\n",
                "\n",
                "    @property\n",
                "    def percentage(self) -> int | None:\n",
                "        \"\"\"Return the current speed as a percentage.\"\"\"\n",
                "        if self._state:\n",
                "            return self._percentage\n",
                "\n",
                "        return None\n",
                "\n",
                "    @property\n",
                "    def oscillating(self) -> bool | None:\n",
                "        \"\"\"Return whether or not the fan is currently oscillating.\"\"\"\n",
                "        return self._oscillating\n",
                "\n",
                "    async def async_oscillate(self, oscillating: bool) -> None:\n",
                "        \"\"\"Set oscillation.\"\"\"\n",
                "        await self._try_command(\n",
                "            \"Setting oscillate on/off of the miio device failed.\",\n",
                "            self._device.set_oscillate,\n",
                "            oscillating,\n",
                "        )\n",
                "        self._oscillating = oscillating\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_direction(self, direction: str) -> None:\n",
                "        \"\"\"Set the direction of the fan.\"\"\"\n",
                "        if self._oscillating:\n",
                "            await self.async_oscillate(oscillating=False)\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Setting move direction of the miio device failed.\",\n",
                "            self._device.set_rotate,\n",
                "            FanMoveDirection(FAN_DIRECTIONS_MAP[direction]),\n",
                "        )\n",
                "\n",
                "\n",
                "class XiaomiFan(XiaomiGenericFan):\n",
                "    \"\"\"Representation of a Xiaomi Fan.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the fan.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._oscillating = self.coordinator.data.oscillate\n",
                "        self._nature_mode = self.coordinator.data.natural_speed != 0\n",
                "        if self._nature_mode:\n",
                "            self._percentage = self.coordinator.data.natural_speed\n",
                "        else:\n",
                "            self._percentage = self.coordinator.data.direct_speed\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "\n",
                "    @property\n",
                "    def preset_mode(self) -> str:\n",
                "        \"\"\"Get the active preset mode.\"\"\"\n",
                "        return ATTR_MODE_NATURE if self._nature_mode else ATTR_MODE_NORMAL\n",
                "\n",
                "    @property\n",
                "    def preset_modes(self) -> list[str]:\n",
                "        \"\"\"Get the list of available preset modes.\"\"\"\n",
                "        return [ATTR_MODE_NATURE, ATTR_MODE_NORMAL]\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._oscillating = self.coordinator.data.oscillate\n",
                "        self._nature_mode = self.coordinator.data.natural_speed != 0\n",
                "        if self._nature_mode:\n",
                "            self._percentage = self.coordinator.data.natural_speed\n",
                "        else:\n",
                "            self._percentage = self.coordinator.data.direct_speed\n",
                "\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "\n",
                "        if preset_mode == ATTR_MODE_NATURE:\n",
                "            await self._try_command(\n",
                "                \"Setting natural fan speed percentage of the miio device failed.\",\n",
                "                self._device.set_natural_speed,\n",
                "                self._percentage,\n",
                "            )\n",
                "        else:\n",
                "            await self._try_command(\n",
                "                \"Setting direct fan speed percentage of the miio device failed.\",\n",
                "                self._device.set_direct_speed,\n",
                "                self._percentage,\n",
                "            )\n",
                "\n",
                "        self._preset_mode = preset_mode\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\"\"\"\n",
                "        if percentage == 0:\n",
                "            self._percentage = 0\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n",
                "        if self._nature_mode:\n",
                "            await self._try_command(\n",
                "                \"Setting fan speed percentage of the miio device failed.\",\n",
                "                self._device.set_natural_speed,\n",
                "                percentage,\n",
                "            )\n",
                "        else:\n",
                "            await self._try_command(\n",
                "                \"Setting fan speed percentage of the miio device failed.\",\n",
                "                self._device.set_direct_speed,\n",
                "                percentage,\n",
                "            )\n",
                "        self._percentage = percentage\n",
                "\n",
                "        if not self.is_on:\n",
                "            await self.async_turn_on()\n",
                "        else:\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiFanP5(XiaomiGenericFan):\n",
                "    \"\"\"Representation of a Xiaomi Fan P5.\"\"\"\n",
                "\n",
                "    def __init__(self, device, entry, unique_id, coordinator):\n",
                "        \"\"\"Initialize the fan.\"\"\"\n",
                "        super().__init__(device, entry, unique_id, coordinator)\n",
                "\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._preset_mode = self.coordinator.data.mode.name\n",
                "        self._oscillating = self.coordinator.data.oscillate\n",
                "        self._percentage = self.coordinator.data.speed\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return FanOperationMode\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._preset_mode = self.coordinator.data.mode.name\n",
                "        self._oscillating = self.coordinator.data.oscillate\n",
                "        self._percentage = self.coordinator.data.speed\n",
                "\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        )\n",
                "        self._preset_mode = preset_mode\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\"\"\"\n",
                "        if percentage == 0:\n",
                "            self._percentage = 0\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n",
                "        await self._try_command(\n",
                "            \"Setting fan speed percentage of the miio device failed.\",\n",
                "            self._device.set_speed,\n",
                "            percentage,\n",
                "        )\n",
                "        self._percentage = percentage\n",
                "\n",
                "        if not self.is_on:\n",
                "            await self.async_turn_on()\n",
                "        else:\n",
                "            self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiFanMiot(XiaomiGenericFan):\n",
                "    \"\"\"Representation of a Xiaomi Fan Miot.\"\"\"\n",
                "\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "    def __init__(self, device, entry, unique_id, coordinator, speed_count):\n",
                    "        \"\"\"Initialize MIOT fan with speed count.\"\"\"\n",
                    "        super().__init__(device, entry, unique_id, coordinator)\n",
                    "        self._speed_count = speed_count\n",
                    "\n"
                ],
                "parent_version_range": {
                    "start": 1046,
                    "end": 1046
                },
                "child_version_range": {
                    "start": 1051,
                    "end": 1056
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    }
                ],
                "idx": 4,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n1043 1048    class XiaomiFanMiot(XiaomiGenericFan):\n1044 1049        \"\"\"Representation of a Xiaomi Fan Miot.\"\"\"\n1045 1050    \n     1051  +     def __init__(self, device, entry, unique_id, coordinator, speed_count):\n     1052  +         \"\"\"Initialize MIOT fan with speed count.\"\"\"\n     1053  +         super().__init__(device, entry, unique_id, coordinator)\n     1054  +         self._speed_count = speed_count\n     1055  + \n1046 1056        @property\n1047 1057        def operation_mode_class(self):\n1048 1058            \"\"\"Hold operation mode class.\"\"\"\n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [],
                "identifiers_after": [
                    "__init__",
                    "_speed_count",
                    "coordinator",
                    "device",
                    "entry",
                    "self",
                    "speed_count",
                    "super",
                    "unique_id"
                ],
                "prefix": [
                    "class XiaomiFanMiot(XiaomiGenericFan):\n",
                    "    \"\"\"Representation of a Xiaomi Fan Miot.\"\"\"\n",
                    "\n"
                ],
                "suffix": [
                    "    @property\n",
                    "    def operation_mode_class(self):\n",
                    "        \"\"\"Hold operation mode class.\"\"\"\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 5,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1054,
                                    "column": 13
                                },
                                "end": {
                                    "line": 1054,
                                    "column": 25
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 4,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1054,
                                    "column": 13
                                },
                                "end": {
                                    "line": 1054,
                                    "column": 25
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 4,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 9,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1054,
                                    "column": 13
                                },
                                "end": {
                                    "line": 1054,
                                    "column": 25
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 4,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return FanOperationMode\n",
                "\n",
                "    @property\n",
                "    def preset_mode(self) -> str | None:\n",
                "        \"\"\"Get the active preset mode.\"\"\"\n",
                "        return self._preset_mode\n",
                "\n",
                "    @callback\n",
                "    def _handle_coordinator_update(self):\n",
                "        \"\"\"Fetch state from the device.\"\"\"\n",
                "        self._state = self.coordinator.data.is_on\n",
                "        self._preset_mode = self.coordinator.data.mode.name\n",
                "        self._oscillating = self.coordinator.data.oscillate\n",
                "        if self.coordinator.data.is_on:\n"
            ],
            {
                "type": "replace",
                "before": [
                    "            self._percentage = self.coordinator.data.speed\n"
                ],
                "after": [
                    "            self._percentage = ranged_value_to_percentage(\n",
                    "                (1, self._speed_count), self.coordinator.data.speed\n",
                    "            )\n"
                ],
                "parent_version_range": {
                    "start": 1063,
                    "end": 1064
                },
                "child_version_range": {
                    "start": 1073,
                    "end": 1076
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if self.coordinator.data.is_on:",
                        "start_line": 1062,
                        "end_line": 1065
                    }
                ],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    },
                    {
                        "type": "function",
                        "name": "_handle_coordinator_update",
                        "signature": "def _handle_coordinator_update(self):",
                        "at_line": 1057
                    }
                ],
                "idx": 5,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n             class XiaomiFanMiot(XiaomiGenericFan):\n                 ...\n                 def _handle_coordinator_update(self):\n                     ...\n1060 1070            self._preset_mode = self.coordinator.data.mode.name\n1061 1071            self._oscillating = self.coordinator.data.oscillate\n1062 1072            if self.coordinator.data.is_on:\n1063       -             self._percentage = self.coordinator.data.speed\n     1073  +             self._percentage = ranged_value_to_percentage(\n     1074  +                 (1, self._speed_count), self.coordinator.data.speed\n     1075  +             )\n1064 1076            else:\n1065 1077                self._percentage = 0\n1066 1078    \n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "_percentage",
                    "coordinator",
                    "data",
                    "self",
                    "speed"
                ],
                "identifiers_after": [
                    "_percentage",
                    "_speed_count",
                    "coordinator",
                    "data",
                    "ranged_value_to_percentage",
                    "self",
                    "speed"
                ],
                "prefix": [
                    "        self._preset_mode = self.coordinator.data.mode.name\n",
                    "        self._oscillating = self.coordinator.data.oscillate\n",
                    "        if self.coordinator.data.is_on:\n"
                ],
                "suffix": [
                    "        else:\n",
                    "            self._percentage = 0\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 4,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1074,
                                    "column": 25
                                },
                                "end": {
                                    "line": 1074,
                                    "column": 37
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 5,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "        else:\n",
                "            self._percentage = 0\n",
                "\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_preset_mode(self, preset_mode: str) -> None:\n",
                "        \"\"\"Set the preset mode of the fan.\"\"\"\n",
                "        if preset_mode not in self.preset_modes:\n",
                "            _LOGGER.warning(\"'%s'is not a valid preset mode\", preset_mode)\n",
                "            return\n",
                "        await self._try_command(\n",
                "            \"Setting operation mode of the miio device failed.\",\n",
                "            self._device.set_mode,\n",
                "            self.operation_mode_class[preset_mode],\n",
                "        )\n",
                "        self._preset_mode = preset_mode\n",
                "        self.async_write_ha_state()\n",
                "\n",
                "    async def async_set_percentage(self, percentage: int) -> None:\n",
                "        \"\"\"Set the percentage of the fan.\"\"\"\n",
                "        if percentage == 0:\n",
                "            self._percentage = 0\n",
                "            await self.async_turn_off()\n",
                "            return\n",
                "\n"
            ],
            {
                "type": "replace",
                "before": [
                    "        await self._try_command(\n",
                    "            \"Setting fan speed percentage of the miio device failed.\",\n",
                    "            self._device.set_speed,\n",
                    "            percentage,\n"
                ],
                "after": [
                    "        speed = math.ceil(\n",
                    "            percentage_to_ranged_value((1, self._speed_count), percentage)\n"
                ],
                "parent_version_range": {
                    "start": 1089,
                    "end": 1093
                },
                "child_version_range": {
                    "start": 1101,
                    "end": 1103
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    },
                    {
                        "type": "function",
                        "name": "async_set_percentage",
                        "signature": "def async_set_percentage(self, percentage: int)->None:",
                        "at_line": 1082
                    }
                ],
                "idx": 6,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n             class XiaomiFanMiot(XiaomiGenericFan):\n                 ...\n                 def async_set_percentage(self, percentage: int)->None:\n                     ...\n1086 1098                await self.async_turn_off()\n1087 1099                return\n1088 1100    \n1089       -         await self._try_command(\n1090       -             \"Setting fan speed percentage of the miio device failed.\",\n1091       -             self._device.set_speed,\n1092       -             percentage,\n     1101  +         speed = math.ceil(\n     1102  +             percentage_to_ranged_value((1, self._speed_count), percentage)\n1093 1103            )\n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "_device",
                    "_try_command",
                    "percentage",
                    "self",
                    "set_speed"
                ],
                "identifiers_after": [
                    "_speed_count",
                    "ceil",
                    "math",
                    "percentage",
                    "percentage_to_ranged_value",
                    "self",
                    "speed"
                ],
                "prefix": [
                    "            await self.async_turn_off()\n",
                    "            return\n",
                    "\n"
                ],
                "suffix": [
                    "        )\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 4,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1102,
                                    "column": 48
                                },
                                "end": {
                                    "line": 1102,
                                    "column": 60
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [
                    {
                        "to_hunk_idx": 9,
                        "detail": {
                            "identifier": "speed",
                            "position": {
                                "start": {
                                    "line": 1101,
                                    "column": 8
                                },
                                "end": {
                                    "line": 1101,
                                    "column": 13
                                }
                            },
                            "type": "identifier",
                            "kind": "variable",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 9,
                        "detail": {
                            "identifier": "speed",
                            "position": {
                                "start": {
                                    "line": 1101,
                                    "column": 8
                                },
                                "end": {
                                    "line": 1101,
                                    "column": 13
                                }
                            },
                            "type": "identifier",
                            "kind": "variable",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 6,
                            "dependency_checked": true
                        }
                    }
                ],
                "other_clones": []
            },
            [
                "        )\n"
            ],
            {
                "type": "delete",
                "before": [
                    "        self._percentage = percentage\n"
                ],
                "after": [],
                "parent_version_range": {
                    "start": 1094,
                    "end": 1095
                },
                "child_version_range": {
                    "start": 1104,
                    "end": 1104
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    },
                    {
                        "type": "function",
                        "name": "async_set_percentage",
                        "signature": "def async_set_percentage(self, percentage: int)->None:",
                        "at_line": 1082
                    }
                ],
                "idx": 7,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n             class XiaomiFanMiot(XiaomiGenericFan):\n                 ...\n                 def async_set_percentage(self, percentage: int)->None:\n                     ...\n1093 1103            )\n1094       -         self._percentage = percentage\n1095 1104    \n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "_percentage",
                    "percentage",
                    "self"
                ],
                "identifiers_after": [],
                "prefix": [
                    "        )\n"
                ],
                "suffix": [
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "\n"
            ],
            {
                "type": "insert",
                "before": [],
                "after": [
                    "        # if the fan is not on, we have to turn it on first\n"
                ],
                "parent_version_range": {
                    "start": 1096,
                    "end": 1096
                },
                "child_version_range": {
                    "start": 1105,
                    "end": 1106
                },
                "control_flow": [],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    },
                    {
                        "type": "function",
                        "name": "async_set_percentage",
                        "signature": "def async_set_percentage(self, percentage: int)->None:",
                        "at_line": 1082
                    }
                ],
                "idx": 8,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n             class XiaomiFanMiot(XiaomiGenericFan):\n                 ...\n                 def async_set_percentage(self, percentage: int)->None:\n                     ...\n1095 1104    \n     1105  +         # if the fan is not on, we have to turn it on first\n1096 1106            if not self.is_on:\n1097 1107                await self.async_turn_on()\n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [],
                "identifiers_after": [],
                "prefix": [
                    "\n"
                ],
                "suffix": [
                    "        if not self.is_on:\n",
                    "            await self.async_turn_on()\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "        if not self.is_on:\n",
                "            await self.async_turn_on()\n"
            ],
            {
                "type": "replace",
                "before": [
                    "        else:\n"
                ],
                "after": [
                    "\n",
                    "        result = await self._try_command(\n",
                    "            \"Setting fan speed percentage of the miio device failed.\",\n",
                    "            self._device.set_speed,\n",
                    "            speed,\n",
                    "        )\n",
                    "\n",
                    "        if result:\n",
                    "            self._percentage = ranged_value_to_percentage((1, self._speed_count), speed)\n"
                ],
                "parent_version_range": {
                    "start": 1098,
                    "end": 1099
                },
                "child_version_range": {
                    "start": 1108,
                    "end": 1117
                },
                "control_flow": [
                    {
                        "type": "if_statement",
                        "statement": "if not self.is_on:",
                        "start_line": 1096,
                        "end_line": 1099
                    },
                    {
                        "type": "else_clause",
                        "statement": "else:",
                        "start_line": 1098,
                        "end_line": 1099
                    }
                ],
                "structural_path": [
                    {
                        "type": "class",
                        "name": "XiaomiFanMiot",
                        "signature": "class XiaomiFanMiot(XiaomiGenericFan):",
                        "at_line": 1043
                    },
                    {
                        "type": "function",
                        "name": "async_set_percentage",
                        "signature": "def async_set_percentage(self, percentage: int)->None:",
                        "at_line": 1082
                    }
                ],
                "idx": 9,
                "hunk_diff": "File: homeassistant/components/xiaomi_miio/fan.py\nCode:\n             class XiaomiFanMiot(XiaomiGenericFan):\n                 ...\n                 def async_set_percentage(self, percentage: int)->None:\n                     ...\n1096 1106            if not self.is_on:\n1097 1107                await self.async_turn_on()\n1098       -         else:\n     1108  + \n     1109  +         result = await self._try_command(\n     1110  +             \"Setting fan speed percentage of the miio device failed.\",\n     1111  +             self._device.set_speed,\n     1112  +             speed,\n     1113  +         )\n     1114  + \n     1115  +         if result:\n     1116  +             self._percentage = ranged_value_to_percentage((1, self._speed_count), speed)\n1099 1117                self.async_write_ha_state()\n1100 1118    \n1101 1119    \n           ...\n",
                "file_path": "homeassistant/components/xiaomi_miio/fan.py",
                "identifiers_before": [
                    "else"
                ],
                "identifiers_after": [
                    "_device",
                    "_percentage",
                    "_speed_count",
                    "_try_command",
                    "ranged_value_to_percentage",
                    "result",
                    "self",
                    "set_speed",
                    "speed"
                ],
                "prefix": [
                    "        if not self.is_on:\n",
                    "            await self.async_turn_on()\n"
                ],
                "suffix": [
                    "            self.async_write_ha_state()\n",
                    "\n",
                    "\n"
                ],
                "base_dependency_callee": [],
                "base_dependency_caller": [],
                "head_dependency_callee": [
                    {
                        "to_hunk_idx": 4,
                        "detail": {
                            "identifier": "_speed_count",
                            "position": {
                                "start": {
                                    "line": 1116,
                                    "column": 67
                                },
                                "end": {
                                    "line": 1116,
                                    "column": 79
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 9,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "speed",
                            "position": {
                                "start": {
                                    "line": 1112,
                                    "column": 12
                                },
                                "end": {
                                    "line": 1112,
                                    "column": 17
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 9,
                            "dependency_checked": true
                        }
                    },
                    {
                        "to_hunk_idx": 6,
                        "detail": {
                            "identifier": "speed",
                            "position": {
                                "start": {
                                    "line": 1116,
                                    "column": 82
                                },
                                "end": {
                                    "line": 1116,
                                    "column": 87
                                }
                            },
                            "type": "identifier",
                            "kind": "unknown",
                            "abs_file_path": "/data2/chenyan/repos/core/homeassistant/components/xiaomi_miio/fan.py",
                            "hunk_idx": 9,
                            "dependency_checked": true
                        }
                    }
                ],
                "head_dependency_caller": [],
                "other_clones": []
            },
            [
                "            self.async_write_ha_state()\n",
                "\n",
                "\n",
                "class XiaomiFanZA5(XiaomiFanMiot):\n",
                "    \"\"\"Representation of a Xiaomi Fan ZA5.\"\"\"\n",
                "\n",
                "    @property\n",
                "    def operation_mode_class(self):\n",
                "        \"\"\"Hold operation mode class.\"\"\"\n",
                "        return FanZA5OperationMode"
            ]
        ]
    },
    "partial_orders": [
        {
            "edit_hunk_pair": [
                0,
                1
            ],
            "edit_order": "bi-directional",
            "reason": "def and import"
        },
        {
            "edit_hunk_pair": [
                0,
                2
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                0,
                3
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                1,
                2
            ],
            "edit_order": "bi-directional",
            "reason": "import and use"
        },
        {
            "edit_hunk_pair": [
                1,
                3
            ],
            "edit_order": "bi-directional",
            "reason": "import and use"
        },
        {
            "edit_hunk_pair": [
                2,
                3
            ],
            "edit_order": "bi-directional",
            "reason": "clone"
        },
        {
            "edit_hunk_pair": [
                3,
                4
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                4,
                5
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                4,
                6
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                4,
                9
            ],
            "edit_order": "bi-directional",
            "reason": "def and use of self._speed_count"
        },
        {
            "edit_hunk_pair": [
                5,
                6
            ],
            "edit_order": "bi-directional",
            "reason": "logical relation"
        },
        {
            "edit_hunk_pair": [
                6,
                9
            ],
            "edit_order": "bi-directional",
            "reason": "def and use"
        },
        {
            "edit_hunk_pair": [
                7,
                9
            ],
            "edit_order": "bi-directional",
            "reason": "maybe a code move, but for safety, we mark as bi-directional"
        },
        {
            "edit_hunk_pair": [
                8,
                9
            ],
            "edit_order": "bi-directional",
            "reason": "implement and comment"
        }
    ]
}